""" Battery Data Analysis Chart Display Module

This module provides the main functionality for battery data analysis and visualization. 
It can read battery data from CSV files, perform data Filtering and processing, generate 
simulated data, and create interactive charts for data visualization.

Main Features:
- Load battery data from CSV files
- Support configuration file reading and custom configuration
- Implement data Filtering algorithms
- Generate simulated battery data
- Create interactive charts with hover, curveToggle and other features

Dependencies:
- matplotlib: for chart drawing
- csv: for CSV file reading
- pathlib: for file path processing
- Logging: for Logging
- traceback: for Error tracing
- configparser: for configuration file parsing
- math: for mathematical calculations
"""

from PyQt6.QtWidgets import QFileDialog, QMessageBox
from PyQt6 import QtCore as QC
from PyQt6.QtCore import Qt
import sys
import logging
from pathlib import Path
import configparser
import traceback
import math
import csv
import os
import matplotlib

# Use QtAgg backend, which automatically detects available Qt bindings (including PyQt6)
# Must set backend before importing pyplot
matplotlib.use('QtAgg')

import matplotlib.pyplot as plt
from matplotlib.ticker import MultipleLocator
from matplotlib.widgets import CheckButtons
from matplotlib.patches import Rectangle, FancyBboxPatch
from matplotlib.colors import to_rgba
from battery_analysis.utils.config_utils import find_config_file
from battery_analysis.i18n.language_manager import get_language_manager, _

# Configure matplotlib to support Chinese display
matplotlib.rcParams['font.sans-serif'] = ['SimHei',
'Microsoft YaHei', 'DejaVu Sans', 'Arial', 'Times New Roman']
matplotlib.rcParams['axes.unicode_minus'] = False  # Solve min us sign display problem

# Modern button style configuration
MODERN_BUTTON_STYLE={
# Button state colors
'active_color':'#2196F3',# Modern blue - active state
'in active_color':'#FFFFFF',# Pure white background - in active state
'hover_color':'#1976D2',# Dark blue - hover state
'pressed_color':'#0D47A1',# Darker blue - pressed state

# Text colors
'active_text_color':'#FFFFFF',# White text when active
'in active_text_color':'#424242',# Dark gray text when in active
'hover_text_color':'#FFFFFF',# White text when hoverin g

# Bor der styles
'bor der_color':'#E0E0E0',# Light gray bor der
'bor der_width':1,
'bor der_radius':6,# Cor ner radius

# Shadow effects
'shadow_color':'0.2',
'shadow_offset':(0,1),

# Font styles
'font_size':8,# Reduce font size to fit button
'font_weight':'medium',# Medium font weight

# Layout parameters
'paddin g':3,# Inner paddin g
'spacin g':1# Button spacin g
}

# Enable matplotlib interactive mode
plt.ion()

# Configure loggin g
logging.basicConfig(level=logging.INFO,
format='%(asctime)s - %(levelname)s - %(message)s')

class BatteryChartViewer:
    """
    Chart generation and data visualization class

    This class is responsible for battery data visualization processin g, including g configuration file reading, data loading, Filterin g and chart generation.
    Suppor ts reading actual data from CSV files or generatin g simulated data, and provides interactive chart in terface for data analysis.

    Attributes:
strPltName: Chart title name
    listColor: Chart color listmaxXaxis: X-axis maximum value
    listPlt: Chart data listlistBatteryNameSplit: Battery name listintBatteryNum: Number of batteries
    in tCurrentLevelNum: Number of Current Levels
    listAxis: Axis ranges
    listXTicks: X-axis tick values
    plot_config: Chart configuration object
    """

    class PlotConfig:
        """
        Chart configuration class for storing configurable chart parameters
        
        Attributes:
        axis_default: Default axis range [xmin, xmax, ymin, ymax]
        axis_special: Axis range under special rules [xmin, xmax, ymin, ymax]
        """
        pass

    def __init__(self, data_path=None):
        """
        Initialize BatteryChartViewer class, set default configuration and load user configuration
        
        Initialize chart parameters, read configuration file, and set default values. If configuration file does not exist,
        use hardcoded default values.

        Args:
        data_path: Optional, specify the directory path to load data
        """
        self.config = configparser.ConfigParser()

        # Initialize language manager
        # Initialize language manager
        self.language_manager = get_language_manager()
        self.language_manager.language_changed.connect(self._on_language_changed)

        # Initialize default configuration
        if not self.config.has_section("PltConfig"):
            self.config.add_section("PltConfig")

        # Get project root config folder path
        current_dir = Path(os.path.dirname(os.path.abspath(__file__)))
        self.project_root = current_dir.parent.parent
        self.path = self.project_root

        # Load configuration file
        self._load_config_file()

        # Initialize chart configuration object
        self.plot_config = self.PlotConfig()

        # Set other initialization parameters
        self.listColor = ['#DF7040', '#0675BE', '#EDB120',
                         '#7E2F8E', '#32CD32', '#FF4500', '#000000', '#000000']
        self.maxXaxis = self.plot_config.axis_default[1]  # Default maximum value
        self.intBatteryNum = 0  # Default no battery data
        self.loaded_data = False  # Data loading status flag
        self.current_fig = None  # Current chart instance reference

        # Initialize axis ranges and ticks
        # [xmin, xmax, ymin, ymax]
        self.listAxis = [self.plot_config.axis_default[0], self.maxXaxis, 
                        self.plot_config.axis_default[2], self.plot_config.axis_default[3]]  # Use configured axis range
        self.listXTicks = list(range(0, self.maxXaxis + 1, 100))  # X-axis tick values

        # Initialize default data structure first
        self.listPlt = []
        self.listBatteryName = []
        self.listBatteryNameSplit = []
        self.strPltPath = None
        self.strInfoImageCsvPath = None

        # Read configuration items
        self._read_configurations()

        # If data path is provided, override path in config file
        if data_path is not None:
            logging.info(f"Data path received during initialization: {data_path}")
            self.set_data_path(data_path)
            success = self.load_data()
            if success:
                self.loaded_data = True
                logging.info(f"Initialization data loading successful")
            else:
                logging.warning(f"Initialization data loading failed")
                # Try to find other possible data files
                self._search_for_data_files()
        else:
            # Default not to load any data, only initialize basic parameters
            logging.info("No data path provided during initialization, not loading data")
        # Try to find other possible data files
        self._search_for_data_files()

    def _on_language_changed(self, language_code):
        """Language switching handling"""
        # Update chart title
        self._update_chart_title()

        # Redraw chart to apply new language
        if self.current_fig is not None:
            self.redraw_chart()

        logging.info(f"Battery chart viewer language switched to: {language_code}")

    def _update_chart_title(self):
        """Update chart title"""
        # Update chart title according to current language
        if hasattr(self, 'strPltTitle'):
            # Try to remove leading and trailing quotes (if exist)
            if (len(self.strPltTitle) >= 2
                and self.strPltTitle[0] == '"'
                and self.strPltTitle[-1] == '"'):
                title_content = self.strPltTitle[1:-1]
            else:
                title_content = self.strPltTitle

            self.strPltName = f"{_('load_voltage_over_charge', 'Load Voltage over Charge')}\n{title_content}"

    def redraw_chart(self):
        """Redraw chart"""
        if hasattr(self, 'current_fig') and self.current_fig is not None:
            try:
                # Close current chart
                plt.close(self.current_fig)

                # Create new chart
                self.create_visualization()
            except Exception as e:
                            logging.error(f"Error redrawing chart: {e}")
                            import traceback
                            traceback.print_exc()

    def set_data_path(self, data_path):
                            """
                            Set data path and update CSV file path

                            Args:
                            data_path: Data directory path to set
                            """
                            logging.info(f"Set data path: {data_path}")
                            self.strPltPath = data_path
                            self.strInfoImageCsvPath = os.path.join(
                            self.strPltPath, "Info_Image.csv")
                            logging.info(f"Updated CSV file path: {self.strInfoImageCsvPath}")

    def load_data(self):
        """
        Load data and process for chart preparation

        Returns:
        bool: Whether data was loaded successfully
        """
        self.listPlt = []
        self.listBatteryName = []
        self.listBatteryNameSplit = []
        self.intBatteryNum = 0

        try:
            self.csv_read()

            # Check if there is valid battery data, only proceed if data exists
            if self.intBatteryNum <= 0:
                logging.error("No valid battery data available, cannot generate chart")
                return False

            # Read and process rule configuration
            self._read_rules_configuration()
            return True
        except Exception as e:
            self.Error_log = str(e)
            logging.error("Error loading data: %s", e)
            traceback.print_exc()
            return False

    def _load_config_file(self):
                            """
                            Load configuration file, prior itize setting.in i, then Config_BatteryAnalysis.ini

                            Try to read configuration file from project root config folder, First look for setting.in i,
                            if not found try to find Config_BatteryAnalysis.ini. If neither file exists,
                            use default configuration and log Warning.

                            Exception handling: catch all exceptions durin g configuration file reading and log Error messages.
                            """
                            try:
                            # Prefer reading setting.in i (release Mode)
                                                                                                                setting_ini_path=find_config_file()
                                                                                                                if setting_ini_path and os.path.exists(setting_ini_path):
                                                                                                                                                                                                                                                                                                                                                self.config.read(setting_ini_path,encoding='utf-8')
                                                                                                                                                                                                                                                                                                                                                logging.info("Successfully read setting.in i configuration")
                                                                                                                                                                                                                                                                                                                                                # When setting.in i exists, do not check Config_BatteryAnalysis.ini
                                                                                                                                                                                                                                                                                                                                                return

                                                                                                                                                                                                                                                                                                                                                # If setting.in i does not exist, try to find Config_BatteryAnalysis.ini (compatible with old version)
                                                                                                                config_battery_path=find_config_file(
                                                                                                                "Config_BatteryAnalysis.ini")
                                                                                                                if config_battery_path and os.path.exists(config_battery_path):
                                                                                                                                                                                                                                                                                                                                                self.config.read(config_battery_path,encoding='utf-8')
                                                                                                                                                                                                                                                                                                                                                logging.info("Successfully read Config_BatteryAnalysis.ini configuration")
                                                                                                                                                                                                                                                                                                                                                return

                                                                                                                logging.warning("Configuration file not found, using default configuration")
                            except Exception as e:
                                                                                                                logging.error("Configuration reading failed: %s, using default configuration", e)

    def _read_configurations(self):
                            """
                            Read all configuration items and set default values

                            Read chart path, title, pulse Current Level, battery Specification type and other configuration items
                            from the loaded configuration file, and set reasonable default values for each configuration item.

                            Configuration items in clude:
                            - Chart path and title
                            - CSV file path
                            - Pulse Current Level configuration
                            - Battery Specification type configuration (coin cell and pouch cell)
                            """
                            # Read chart path configuration
                            self.strPltPath = self._get_config_value(
                            "PltConfig","Path",os.getcwd())

                            # Read chart title configuration
                            self.strPltTitle = self._get_config_value(
                            "PltConfig","Title","Battery Test Results")

                            # Set CSV file path
                            self.strInfoImageCsvPath = os.path.join(
                            self.strPltPath,"Info_Image.csv")

                            # Read pulse Current Level configuration
                            self.listPulseCurrentLevel=self._get_pulse_current_level()
                            self.intCurrentLevelNum=len(self.listPulseCurrentLevel)

                            # Read battery Specification type configuration
                            self.listCoinCell=self._get_config_list(
                            "BatteryConfig","SpecificationTypeCoinCell")
                            self.listPouchCell=self._get_config_list(
                            "BatteryConfig","SpecificationTypePouchCell")

                            # Set chart title
                            self.strPltName = self._set_plot_title()

    def get_axis_default(self):
                            """
                            Get default axis range
        
                            Returns:
                            lis t: Default axis range [xmin, xmax, ymin, ymax]
                            """
                            return self.plot_config.axis_default

    def set_axis_default(self,xmin,xmax,ymin,ymax):
                            """
                            Set default axis range
        
                            Args:
                            xmin: X-axis minimum value
                            xmax: X-axis maximum value
                            ymin: Y-axis minimum value
                            ymax: Y-axis maximum value
                            """
                            self.plot_config.axis_default = [xmin, xmax, ymin, ymax]
                            # If currently using default range, sync update current listAxis
                            if self.listAxis[0] == self.plot_config.axis_default[0] and self.listAxis[2] == self.plot_config.axis_default[2] and self.listAxis[3] == self.plot_config.axis_default[3]:
                                self.listAxis = [xmin, self.maxXaxis, ymin, ymax]

    def get_axis_special(self):
                            """
                            Get axis range under special rules
        
                            Returns:
                            lis t: Axis range under special rules [xmin, xmax, ymin, ymax]
                            """
                            return self.plot_config.axis_special

    def set_axis_special(self,xmin,xmax,ymin,ymax):
                            """
                            Set axis range under special rules
        
                            Args:
                            xmin: X-axis minimum value
                            xmax: X-axis maximum value
                            ymin: Y-axis minimum value
                            ymax: Y-axis maximum value
                            """
                            self.plot_config.axis_special = [xmin, xmax, ymin, ymax]

    def get_plot_config(self):
                            """
                            Get entire chart configuration object
        
                            Returns:
                            PlotConfig: Chart configuration object
                            """
                            return self.plot_config

    def _get_config_value(self,section,option,default_value):
                            """
                            Safely get configuration value, return default if not exists

                            Read the value of the specif ied section and option from the configuration file. If section or option does not exist,
                            or an exception occurs durin g reading, return the provided default value and log cor respondin g Infor mation.

                            Args:
                            section(str): Section name in configuration file
                            option(str): Configuration item name
                            default_value: Default value, returned when configuration item does not exist

                            Returns:
                            Configuration value or default value
                            """
                            try:
                                if self.config.has_section(section) and self.config.has_option(section,option):
                                    value=self.config.get(section,option)
                                    logging.debug("Get configuration %s/%s: %s",section,option,value)
                                    return value
                                else:
                                    logging.warning(
                                    "Configuration %s/%s not found, using default: %s",section,option,default_value)
                                    return default_value
                            except Exception as e:
                                logging.error(
                                "Error reading configuration %s/%s: %s, using default: %s",section,option,e,default_value)
                                return default_value

    def _get_config_list(self,section,option):
                            """Safely get configuration list, return empty list if not exists"""
                            try:
                                if self.config.has_section(section) and self.config.has_option(section,option):
                                    list_value=self.config.get(section,option).split(",")
                                    cleaned_list= [item.strip() for item in list_value]
                                    logging.debug("Get configuration list %s/%s: %s",section,
                                    option,cleaned_list)
                                    return cleaned_list
                                else:
                                    logging.warning("Configuration list %s/%s not found, using empty list",section,option)
                                    return []
                            except Exception as e:
                                logging.error("Error reading configuration list %s/%s: %s, using empty list",section,option,e)
                                return []

    def _get_pulse_current_level(self):
                            """Get pulse Current Level configuration"""
                            try:
                                if(self.config.has_section("BatteryConfig")
                                and self.config.has_option("BatteryConfig","PulseCurrent")):
                                    listPulseCurrentLevel=self.config.get(
                                    "BatteryConfig","PulseCurrent").split(",")
                                    result= [int(item.strip()) for item in listPulseCurrentLevel]
                                    logging.info("Using configured pulse Current Level: %s",result)
                                    return result
                                else:
                                    default_value= [10,20,50]
                                    logging.warning(
                                    "BatteryConfig/PulseCurrent not found, using default: %s",default_value)
                                    return default_value
                            except Exception as e:
                                default_value= [10,20,50]
                                logging.error("Pulse current configuration format Error: %s, using default: %s",e,default_value)
                                return default_value

    def _set_plot_title(self):
                            """Set chart title, handle quote situations"""
                            try:
                                # Try to remove leading and trailing quotes (if exist)
                                if(len(self.strPltTitle)>=2
                                and self.strPltTitle[0]=='"'
                                and self.strPltTitle[-1]=='"'):
                                    title_content=self.strPltTitle[1:-1]
                                else:
                                    title_content=self.strPltTitle
                                return f"Load Voltage over Charge\n{title_content}"
                            except Exception as e:
                                default_title="Load Voltage over Charge\nUnknown Battery"
                                logging.error("Error setting chart title: %s, using default title: %s",e,default_title)
                                return default_title

    def _read_rules_configuration(self):
                            """Read and process rule configuration"""
                            try:
                                                                                                                if(self.config.has_section("BatteryConfig")
                                                                                                                and self.config.has_option("BatteryConfig","Rules")):
                                                                                                                                                                                                                                                                                                                                                listRules=self.config.get(
                                                                                                                                                                                                                                                                                                                                                "BatteryConfig","Rules").split(",")
                                                                                                                                                                                                                                                                                                                                                self._process_rules(listRules)
                                                                                                                else:
                                                                                                                                                                                                                                                                                                                                                logging.warning("BatteryConfig/Rules not found, using default maxXaxis")
                            except Exception as e:
                                                                                                                logging.error("Error reading Rules configuration: %s, using default maxXaxis",e)

    def _process_rules(self,listRules):
                            """Process maxXaxis accor din g to rule configuration"""
                            try:
                                                                                                                if len(self.strPltName.split(" "))>4:
                                                                                                                                                                                                                                                                                                                                                spec_type=self.strPltName.split(" ")[4]
                                                                                                                for rulein listRules:
                                                                                                                                                                                                                                                                                                                                                if spec_typein ruleand"/"in rule:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        rule_parts=rule.split("/")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if len(rule_parts)>2:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        try:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                self.maxXaxis = in t(rule_parts[2])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                logging.info(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                "Set maxXaxis accor din g to rule: %s",self.maxXaxis)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # Synchronously update axis scope and scale
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                self.listAxis= [self.plot_config.axis_special[0],self.maxXaxis,self.plot_config.axis_special[2],self.plot_config.axis_special[3]]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                self.listXTicks=lis t(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                range(0,self.maxXaxis+1,100))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                break
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        except ValueError:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                logging.warning(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                "Invalid maxXaxis value in rule: %s",rule_parts[2])
                            except Exception as e:
                                                                                                                logging.error("Error processin g rule: %s, keepin g default maxXaxis",e)

    def csv_read(self):
                            """
                            Read data from CSV file

                            Data processing flow:
                            1. Check if CSV file exists
                            2. Initialize Data Structure
                            3. Read and process CSV data
                            4. Parse battery names
                            5. Filter data

                            Impor tant not e: This method only uses real data from CSV files, will not generate or use Any simulated data.
                            If CSV file does not exist or reading fails, will log Error and return, will not automatically generate alternative data.
                            Exception handling: catch all exceptions durin g reading and processing, and log detailed Infor mation.
                            """
                            try:
                                                                                                                logging.info("Start reading CSV file: %s",self.strInfoImageCsvPath)

                                                                                                                # Check if file exists
                                                                                                                csv_path=Path(self.strInfoImageCsvPath)
                                                                                                                if not csv_path.exists():
                                                                                                                                                                                                                                                                                                                                                logging.error("Error: CSV file not found %s",self.strInfoImageCsvPath)
                                                                                                                                                                                                                                                                                                                                                self.intBatteryNum=0
                                                                                                                                                                                                                                                                                                                                                return

                                                                                                                                                                                                                                                                                                                                                # Check file size
                                                                                                                file_size=csv_path.stat().st_size
                                                                                                                if file_size==0:
                                                                                                                                                                                                                                                                                                                                                logging.error("Error: CSV file %s is empty",self.strInfoImageCsvPath)
                                                                                                                                                                                                                                                                                                                                                self.intBatteryNum=0
                                                                                                                                                                                                                                                                                                                                                return

                                                                                                                                                                                                                                                                                                                                                # Initialize Data Structure
                                                                                                                self._Initialize_data_structures()

                                                                                                                # Use context manager to safely read file
                                                                                                                withopen(csv_path,'r',encoding='utf-8')asf:
                                                                                                                                                                                                                                                                                                                                                csvreader=csv.reader(f)
                                                                                                                                                                                                                                                                                                                                                # Read ownership row to verif y data amount
                                                                                                                                                                                                                                                                                                                                                all_rows=lis t(csvreader)
                                                                                                                                                                                                                                                                                                                                                if len(all_rows)<5:                                                                                                                                                                                                                                                                                                                                                # At least need several row data to be expected to contain valid battery info
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        logging.error(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        "Error: CSV file %s data row number in sufficient",self.strInfoImageCsvPath)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        self.intBatteryNum=0
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        return

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # Reset reader to process data
                                                                                                                                                                                                                                                                                                                                                f.seek(0)
                                                                                                                                                                                                                                                                                                                                                csvreader=csv.reader(f)
                                                                                                                                                                                                                                                                                                                                                self._process_csv_data(csvreader)

                                                                                                                                                                                                                                                                                                                                                self.intBatteryNum=len(self.lis tBatteryName)

                                                                                                                                                                                                                                                                                                                                                # Check if valid data was read
                                                                                                                                                                                                                                                                                                                                                if self.intBatteryNum==0:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        logging.error("Error: CSV file middle not have found valid battery in for mation")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        logging.warning("Please confirm CSV file for mat cor rect, contain s battery test data")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        return

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # Parse Battery Name
                                                                                                                                                                                                                                                                                                                                                self._parse_battery_names()

                                                                                                                                                                                                                                                                                                                                                # Filter Data
                                                                                                                                                                                                                                                                                                                                                self._filter_all_data()

                                                                                                                                                                                                                                                                                                                                                # Verif y Filtered data
                                                                                                                                                                                                                                                                                                                                                data_valid=False
                                                                                                                                                                                                                                                                                                                                                for cin range(self.in tCurrentLevelNum):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if c<len(self.listPlt)and self.listPlt[c][2]:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # Check Filtered data
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        data_valid=True
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        break

                                                                                                                                                                                                                                                                                                                                                if not data_valid:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        logging.error("Error: Filtered back not have valid battery data available for display")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        self.intBatteryNum=0
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        return

                                                                                                                                                                                                                                                                                                                                                logging.info("Successfully read and process CSV data, contain s %d batteries' real test data",self.intBatteryNum)
                            except FileNotFoundError:
                                                                                                                logging.error("Error: File not yet found: %s",self.strInfoImageCsvPath)
                                                                                                                self.intBatteryNum=0
                            except Permis sionError:
                                                                                                                logging.error("Error: No permis sion to access file: %s",self.strInfoImageCsvPath)
                                                                                                                self.intBatteryNum=0
                            except Exception as e:
                                                                                                                logging.error("Error: Exception occurred while reading CSV file: %s",str(e))
                                                                                                                logging.error("Error type: %s",type(e).__name__)
                                                                                                                traceback.prin t_exc()
                                                                                                                self.intBatteryNum=0

    def _Initialize_data_structures(self):
                            """
                            Initialize Data Structure

                            Create and Initialize Data Structure for stor in g battery data.
                            Generate 3D listfor stor in g or igin al and filtered data of every current level ownership battery.
                            Lis t structure: listPlt[current level][data type][battery in dex][data poin t]
                            where data type: 0-or igin al chargin g data, 1-or igin al voltage data, 2-filtered chargin g data, 3-filtered voltage data
                            """
                            self.listPlt= []
                            self.listBatteryName= []
                            self.listBatteryNameSplit= []

                            for cin range(self.in tCurrentLevelNum):
                                                                                                                self.listPlt.append([])
                                                                                                                for _in range(4):                                                                                                                # 0: or igin al chargin g data, 1: or igin al voltage data, 2: filtered chargin g data, 3: filtered voltage data
                                                                                                                                                                                                                                                                                                                                                self.listPlt[c].append([])

    def _process_csv_data(self,csvreader):
                            """
                            Process CSV data and fill in to Data Structure middle

                            Process data from CSV reader middle and fill in to Data Structure middle. Classif y data in CSV by battery and current level,
                            Stor e Origin al Data. Perfor m Exception Detection durin g processing, skip in valid row, and record warning log.

                            Args:
                            csvreader: CSV data reader
                            """
                            in tPerBatteryRows=1+self.in tCurrentLevelNum*3
                            in dex=0

                            for rowin csvreader:
                            loop=in dex%in tPerBatteryRows
                            if loop==0:
    #New battery start row
                            if len(row)>1:
                            self.listBatteryName.append(row[1].strip())
                            else:
                            #Datarow,Fill data accor din g to for mat rules
                            if(loop%3)!=1:
                            try:
                            current_idx=in t((loop-1)/3)
                            data_idx=((loop-1)%3)-1
                            #Ensure in dex is within valid scope
                            if 0<=current_idx<self.in tCurrentLevelNumand 0<=data_idx<4:
    #Try to convert ownership data to float
                            float_data= [float(row[i])
                            for iin range(len(row))]
                            self.listPlt[current_idx][data_idx].append(float_data)
                            except(ValueError,IndexError)ase:
                            Logging.Warning("Error parsin g CSV row data: %s,Skip this row",e)
                            in dex+=1

    def _parse_battery_names(self):
                            """
                            Parse battery name, extract meanin gful identif ier

                            Extract meanin gful part from battery name,Generate concis e and readable battery identif ier.
                            Prior ity search for BTS identif ier back part,If exists, extract key Info from middle
                            If BTS identif ier does not exist, use back part of name or default name.
                            Perfor m Exception Detection durin g processin g, ensure even if parse failed can return valid default name.
                            """
                            for bin range(self.intBatteryNum):
                            try:
                # Try to extract BTS back identif ier part
                            if "BTS" in self.listBatteryName[b]:
                            strBatteryNameSplit = self.listBatteryName[b].split("BTS")[1].split("_")
                            if len(strBatteryNameSplit) >=4:
                            strBatteryName = f"{strBatteryNameSplit[2]}_{strBatteryNameSplit[3]}"
                            else:
                        # If divis ion back part in sufficient, use available part
                            strBatteryName = "_".join(strBatteryNameSplit[1:3]) if len(strBatteryNameSplit) >= 3 else f"Battery_{b}"
                            else:
                    # If not have BTS identif ier, use or igin al name's back part or default name
                            name_parts = self.listBatteryName[b].split("_")
                            strBatteryName = "_".join(
                            name_parts[-2:]) if len(name_parts) >= 2 else f"Battery_{b}"

                                        self.listBatteryNameSplit.append(strBatteryName)
                            except Exception as e:
                                        Logging.Warning(
                                        "Error parsin g battery name: %s, Use default name",e)
                                        strBatteryName=f"Battery_{b}"
                                        self.listBatteryNameSplit.append(strBatteryName)

    def Filter_data(self,lis t_plt_charge:lis t,lis t_plt_voltage:lis t,
                            times=5,slope_max=0.2,dif ference_max=0.05):
                            """
                            Filter data to remove exception values and nois e

                            Implement a Filter algor ithm based on slope and voltage dif ference,Used to remove exception values and nois e in battery data.
                            Through multiple iterations of Filtering,Gradually smooth data curve,While retain in g overall trend of data.

                            Args:
                            lis t_plt_charge: chargin g data listlis t_plt_voltage: voltage data listtimes: Filter iteration count, default is 5 times
                            slope_max: allowed maximum slope, default is 0.2
                            dif ference_max: allowed maximum voltage dif ference, default is 0.05

                            Returns:
                            tuple: Filtered chargin g data and voltage data
                            """
                            Filtered_charge= []
                            Filtered_voltage= []

                            for pin range(len(lis t_plt_charge)):
                            charge_sin gle=lis t_plt_charge[p]
                            voltage_sin gle=lis t_plt_voltage[p]
                            current_times=times

                            while current_times>0:
                            charge_temp= [charge_sin gle[0]]
                            voltage_temp= [voltage_sin gle[0]]

                            for cin range(1,len(charge_sin gle)):
    #Calculateslope, avoid divis ion by zero
                            charge_dif f=charge_sin gle[c]-charge_sin gle[c-1]
                            if charge_dif f==0:
                            slope=slope_max
                            else:
                            slope=abs(
                            (voltage_sin gle[c]-voltage_sin gle[c-1])/charge_dif f)

                            #Accor din g to slope and voltage dif ference for row Filter
                            if(slope<slope_max
                            and abs(voltage_sin gle[c]-voltage_sin gle[c-1])<dif ference_max):
                            charge_temp.append(charge_sin gle[c])
                            voltage_temp.append(voltage_sin gle[c])

                            charge_sin gle=charge_temp
                            voltage_sin gle=voltage_temp
                            current_times-=1

                            Filtered_charge.append(charge_sin gle)
                            Filtered_voltage.append(voltage_sin gle)

                            returnFiltered_charge,Filtered_voltage

    def _Filter_all_data(self):
                            """
                            Filter ownership battery data

                            Apply Filter algor ithm to ownership battery data.Traverse every Current Level and battery data,
                            Apply Filter_data method for data smoothin g process,Remove exception values and nois e.
                            Perfor m Exception Detection durin g processing,Ensure sin gle battery data processing failure cannot impact whole process.
                            """
                            for cin range(self.in tCurrentLevelNum):
                            try:
    #Check if data is valid
                            if c<len(self.listPlt)and len(self.listPlt[c])>=4:
                            if self.listPlt[c][0]and self.listPlt[c][1]:
                            self.listPlt[c][2],self.listPlt[c][3]=self.Filter_data(
                            self.listPlt[c][0],self.listPlt[c][1])
                            except Exception as e:
                            Loggin g.Error("Error Filtering data (Current Level %s): %s",c,e)

    def plt_figure(self):
                            """Create and show battery data chart, contain s interactive controls to Switch data display

                            Impor tant explanation:This method only uses real data from CSV file,
                            If there is no valid battery data or Error occurs durin g plottin g process,Can show detailed Error Info and troubleshootin g suggestions.
                            """
                            try:
    #Start drawing chart
                            Loggin g.Info("Start drawing chart")

                            #Perfor mmulti-level data validity Checks
                            if self.intBatteryNum<=0:
                            Logging.Error("Error: Not havevalid battery data available for display")
                            self._show_Error _plot()
                            return

                            #Check if necessary Data Structure is valid
                            if not hasattr(self,'listPlt')or not self.listPlt:
                            Logging.Error("Error: Battery Data Structure Not Yet Initialized or empty")
                            self._show_Error _plot()
                            return

                            #Initialize chart and axes
                            try:
                            fig,ax,title_fontdict,axis _fontdict=self._Initialize_figure()
                            if figis Noneor axis None:
                            rais eValueError("Cannot Initialize chart or coor din ate axes")

                            #Save current chart instance reference
                            self.current_fig = fig

                            #Add menu bar
                            self._add_menu_bar(fig)
                            except Exceptionasin it_Error:
                            Logging.Error("Chart Initialization failed: %s",str(in it_Error))
                            self._show_Error _plot()
                            return

                            #Plot battery data Curves
                            try:
                            Lin es_unFiltered,Lin es_Filtered=self._plot_battery_Curves(ax)
                            valid_data_found=bool(
                            Lin es_Filtered)or bool(Lin es_unFiltered)

                            if valid_data_found:
                            Logging.Info(
                            "Successfullyfully plotted %d Filtered Curves and %d or igin al Curves",len(Lin es_Filtered),len(Lin es_unFiltered))
                            except Exceptionasplot_Error:
                            Logging.Error("Error plottin g battery Curves: %s",str(plot_Error))
                            Lin es_unFiltered,Lin es_Filtered= [],[]
                            valid_data_found=False

                            #Check if Curves were successfully plotted
                            if not valid_data_found:
                            Logging.Error("Critical Error: Cannot plot Any battery data Curves")
                            self._show_Error _plot()
                            return

                            #Add interactive controls
                            try:
                            Check_Filter=self._add_Filter_button(
                            fig,ax,Lin es_unFiltered,Lin es_Filtered,title_fontdict,axis _fontdict)
                            self._add_battery_selection_buttons(
                            fig,Check_Filter,Lin es_unFiltered,Lin es_Filtered
                            )
                            self._add_hover_functionality(
                            fig,ax,Lin es_Filtered,Lin es_unFiltered,Check_Filter)
                            self._add_help_text(fig)
                            Logging.Info("Successfullyfully added chart interactive controls")
                            except Exceptionasui_Error:
                            Logging.Warning("Add interactive controlsWhenError Occurred: %s",str(ui_Error))
                            #Even if interactive controls additionfailed,Still try to show chart

                            Logging.Info("Chart creation complete,Show real battery test data from CSV file")

                            #Show chart in PyQtapplication,Ensure compatibility with Qt event loop
                            #Setup as interactive Mode
                            plt.ion()

                            #Ensure window is always on top and cor rectly shown
                            plt.show(block=False)

                            #Ensure window shows on top and obtain s focus
                            try:
                            if hasattr(fig.canvas.manager,'window'):
    #For Qt backend
                            window=fig.canvas.manager.window

                            #Setup window flags
                            window.setWin dowFlags(Qt.Win dowType.Win dow|
                            Qt.Win dowType.Win dowMin imizeButtonHin t|
                            Qt.Win dowType.Win dowMaximizeButtonHin t|
                            Qt.Win dowType.Win dowCloseButtonHin t)

                            #Activate and show window
                            window.showNor mal()                            #Ensure window is not min imized status
                            window.show()
                            window.activateWin dow()
                            window.rais e_()

                            #Ensure window is Vis ible
                            window.setWin dowState(Qt.Win dowState.Win dowActive)

                            #Setup window position at screen center
                            screen=window.screen().availableGeometry()
                            window.move(in t((screen.width()-window.width())/2),
                            in t((screen.height()-window.height())/2))

                            #For ce refresh window
                            window.repain t()
                            window.update()
                            except Exception as e:
                            Logging.Warning("Cannot brin g window to top: %s",str(e))

                            #Add pause time to ensure cor rect window renderin g
                            plt.pause(0.5)

                            #Explicitly update chart
                            fig.canvas.draw()
                            fig.canvas.flush_events()

                            #Update again to ensure stable window display
                            fig.canvas.draw()

                            except Exception as e:
                            Loggin g.Error("Critical Error: Unexpected exception occurred durin g chart drawing: %s",str(e))
                            Logging.Error("Error Type: %s",type(e).__name__)
                            traceback.prin t_exc()
                            self._show_Error _plot()

    def _search_for _data_files(self):
                            """
                            Search for expected Info_Image.csv file in project
        
                            This method can search for expected Info_Image.csv file in project root director y bottom,
                            If found, can automatically load the file.
                            """
                            try:
                            Logging.Info("Start searchin g for Info_Image.csv file in project middle...")

                            #Search in project root director y bottom
                            for root,dirs,filesin os.walk(self.project_root):
    #Skip hide director ies and venv director ies
                            if".venv"in rootor".git"in rootor"__pycache__"in root:
                            continue

                            if"Info_Image.csv"in files:
                            Info_image_csv=os.path.join(root,"Info_Image.csv")
                            Logging.Info(f"Fin d Info_Image.csv file in project middle: {Info_image_csv}")

                            #Setup data path and try to load
                            self.set_data_path(os.path.dirname(Info_image_csv))
                            success=self.load_data()
                            if success:
                            self.loaded_data = True
                            Logging.Info("Successfully load found data file")
                            return
                            else:
                            Logging.Warning("Fin d data file but load failed")

                            Logging.Warning("Not yet find Any valid Info_Image.csv file in project middle")
                            except Exception as e:
                            Logging.Error("SearchDataFileWhenError Occurred: %s",str(e))
                            impor t traceback
                            traceback.prin t_exc()

    def _show_Error _plot(self,title=None,main_message=None,details=None):
                            """
                            Show detailed Error Info chart, provide clear Error feedback and troubleshootin g suggestions

                            Args:
                            title (str, optional): Error title, default is "DataError"
                            main_message (str, optional): Main Error Info, default is "Cannot Load or Show Battery Data"
                            details (str, optional): Detailed Error Info and troubleshootin g suggestions
                            """
                            try:
                            if titleis None:
                            title=_("data_Error _title","DataError")
                            if main_messageis None:
                            main_message=_("data_Error _message","Cannot Load or Show Battery Data")
                            if detailsis None:
                            details=_("data_Error _details","1. csv file exists and for mat cor rect\n"
                            "2. configure file is cor rectly chosen\n"
                            "3. file path contain s middle text characters or special characters\n"
                            "4. csv file contain s valid battery test data")

                            #CreateError Chart
                            fig,ax=plt.subplots(figsize=(10,6))

                            #Save current chart instance reference
                            self.current_fig = fig

                            #Set chart title
                            ax.set_title(title,fontsize=16,
                            fontweight='bold',color='#d32f2f')

                            #Hide coor din ate axes
                            ax.axis('off')

                            #Construct complete Error Info text
                            full_text=f"{main_message}\n\n"
                            full_text+="CheckStep:\n"
                            full_text+=details

                            #Show Error log Info(if Any)
                            if hasattr(self,'Error log')and self.Error log:
                            full_text+=f"\n\nError details: {str(self.Error log)}"

                            #ShowError Info
                            ax.text(0.5,0.5,full_text,fontsize=12,ha='center',va='center',
                            wrap=True,lin espacin g=1.4)

                            #Add version Info and timestamp
                            impor t datetime
                            current_time=datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S")
                            fig.text(0.85,0.01,f"Battery Analysis Tool v1.0 | {current_time}",
                            fontsize=8,color='gray')

                            #Add bor der and style
                            for spin ein ax.spin es.values():
                            spin e.set_color('#ff5722')
                            spin e.set_lin ewidth(1)

                            #Add menu bar(including g open function)
                            self._add_menu_bar(fig)

                            Logging.Info("ShowError InfoChart: %s - %s",title,main_message)
                            plt.tight_layout()

                            #Show Error chart in PyQt applicationmiddle, ensure compatibility with Qt event loop
                            #Check if already in interactive Mode
                            if not plt.is interactive():
                            plt.ion()

                            plt.show(block=False)
                            plt.pause(0.1)                            #Add pause time to ensure cor rect window renderin g

                            #Explicitly update canvas
                            fig.canvas.draw()
                            fig.canvas.flush_events()

                            except Exception as e:
                            Logging.critical("ShowError ChartWhenOccurredException: %s",str(e))
                            traceback.prin t_exc()
                            #If even Error chart cannot beshown, try to use simple text output
                            Logging.Error("\nCritical Error: Cannot show graphical in terface Error Info")
                            Logging.Error(
                            "Error details: %s - %s",titleor'unknown Error',main_messageor'Cannot load data')
                            Logging.Info("\nPlease Check the followin g items:")
                            Logging.Info("1. Python environment is cor rectly in stalled")
                            Logging.Info("2. Matplotlib library is available")
                            Logging.Info("3. CSV file exists and for mat cor rect")
                            Logging.Info("4. System has enough resources to show graphics")

    def _cleanup_matplotlib_state(self):
                            """
                            Clean matplotlib status, ensure new chart can nor mally wor k
                            """
                            Logging.Info("StartCleanMatplotlibStatus")
                            impor t matplotlib
                            impor t matplotlib.pyplotasplt

                            #Reset matplotlib in ternal status(not close current chart, avoid event bin din g failure)
                            matplotlib.rcParams.update(matplotlib.rcParamsDefault)

                            #Reconfigure middle text fontsupport, avoid loss after reset
                            matplotlib.rcParams['font.sans-serif']= ['SimHei','Microsoft YaHei','DejaVu Sans','Arial','Times New Roman']
                            matplotlib.rcParams['axes.unicode_minus']=False                            #Solve min us sign display problem

                            #Ensure to use cor rect backend
                            if matplotlib.get_backend()!='QtAgg':
                            Logging.Info(f"Current matplotlib backend: {matplotlib.get_backend()}, Switch to QtAgg backend")
                            matplotlib.use('QtAgg')

                            Logging.Info("MatplotlibStatusCleanComplete")

    def _open_file_dialog(self):
                            """
                            Open file dialog, allow user to choose data file
                            """
                            Logging.Info("=== _open_file_dialogMethodStartExecute ===")
                            try:
                            Logging.Info("Try to open file dialog, choose data director y")

                            data_dir=None

                            #Use Qt file dialog
                            Logging.Info("Try to use Qt file dialog")
                            try:
    #Open director y choose dialog
                            data_dir=QFileDialog.getExis tin gDirector y(
                            None,                            # parent window
                            "Choose Data Director y",                            #Dialog Title
                            self.strPltPathor".",                            # default director y
                            QFileDialog.Option.ShowDirsOnly                            # show director ies only
                            )
                            Logging.Info(f"Use Qt file dialog successfully, return value: {data_dir}")
                            except Exceptionasqt_Error:
                            Logging.Error(f"Qt file dialog failed: {qt_Error}")

                            if data_dir:
                            Logging.Info(f"User chosen data director y: {data_dir}")
                            #Setup data path and reload data
                            self.set_data_path(data_dir)
                            success=self.load_data()
                            if success:
                            Logging.Info("DataLoadSuccessfully,RedrawChart")

                            #Clean matplotlib status(ensure new chart has cor rect event bin din g)
                            self._cleanup_matplotlib_state()

                            #Close current chart instance(if exists), ensure newly created chart instance is unique
                            if self.current_figis not None:
                            plt.close(self.current_fig)
                            self.current_fig = None

                            #RedrawChart
                            self.plt_figure()
                            else:
                            Logging.Error("DataLoadFailed,Cannot ShowChart")
                            except Exception as e:
                            Logging.Error("Error occurred When openin g file dialog: %s",str(e))
                            traceback.prin t_exc()

    def _show_about_dialog(self):
                            """
                            Show about dialog
                            """
                            try:
    #Get version Info
                            try:
                            impor t datetime
                            current_time=datetime.datetime.now().strftime("%Y")
                            except:
                            current_time="2024"

                            #Readpyproject.tomlGet version Info
                            version_Info="v2.1.1"
                            try:
                            impor t configparser
                            config=configparser.ConfigParser()
                            pyproject_path=Path(__file__).parent.parent.parent/"pyproject.toml"
                            if pyproject_path.exists():
                            config.read(pyproject_path,encoding='utf-8')
                            if'project'in configand'version'in config['project']:
                            version_Info=config['project']['version']
                            except:
                            pass

                            #Create about Info text
                            about_text=f"""Battery Analysis Tool
                            Version: {version_Info}

                            Battery Test Data Vis ualization Analysis Application
                            Suppor t multiple data for mat impor t and chart generation

                            Function features:
                             Suppor tCSVFileDataImpor t
                             Interactive chart display and operation
                             Data Filter and unFilter Toggle
                             Battery choose and channel control
                             Hover to show detailed Info

                            Developer: Ewin BatteryAnalyzeTeam
                            Copyright:  {current_time} MIT License

                            Thank you for using Battery Analysis Tool!"""

                            #Show about dialog
                            msg_box=QMessageBox()
                            msg_box.setWin dowTitle("About")
                            msg_box.setText(about_text)
                            msg_box.setIcon(QMessageBox.Icon.Infor mation)
                            msg_box.setStand ardButtons(QMessageBox.Stand ardButton.Ok)
                            msg_box.exec()

                            Logging.Info("About dialog show complete")

                            except Exception as e:
                            Logging.Error(f"Show about dialogFailed: {e}")
                            #If dialogfailed, at least prin t to log
                            prin t(f"Battery Analysis Tool v2.1.1\nDeveloper: Ewin BatteryAnalyzeTeam")

    def _add_menu_bar(self,fig):
                            """
                            Add menu bar for chart (unif y use PyQt6)

                            Args:
                            fig: matplotlib FigureObject
                            """
                            try:
                            Logging.Info("Start addin g PyQt6 menu bar")

                            #Get chart window manager
                            manager=fig.canvas.manager
                            if not hasattr(manager,'window'):
                            rais eRuntimeError("Cannot get matplotlib window manager")

                            #AddPyQt6 menu bar
                            if hasattr(manager.window,'menuBar'):
                            menubar=manager.window.menuBar()

                            #Add file menu
                            file_menu=menubar.addMenu('File')

                            #Add open menu item
                            open_action=file_menu.addAction('Open')

    def on_open_clicked():
                            Logging.Info("Open menu item clicked")
                            self._open_file_dialog()

                            open_action.triggered.connect(on_open_clicked)

                            #Add divis ion lin e
                            file_menu.addSeparator()

                            #Add exit menu item
                            exit_action=file_menu.addAction('Exit')

    def on_exit_clicked():
                            Logging.Info("Exit menu item clicked, close vis ualizer window")
                            #Only close current vis ualizerwindow, not exit entire application
                            if self.current_figis not None:
                            plt.close(self.current_fig)
                            self.current_fig = None
                            Logging.Info("Vis ualizer window closed")
                            else:
                            Logging.Warning("Currently no open vis ualizer window")

                            exit_action.triggered.connect(on_exit_clicked)

                            #Add help menu
                            help_menu=menubar.addMenu('Help')

                            #Add about menu item
                            about_action=help_menu.addAction('About')

    def on_about_clicked():
                            Logging.Info("About menu item clicked")
                            self._show_about_dialog()

                            about_action.triggered.connect(on_about_clicked)
                            Logging.Info("SuccessfullyAdd PyQt6 menu bar")
                            else:
                            rais eRuntimeError("Win dow does not support menu bar")

                            except Impor tError ase:
                            rais eImpor tError(f"PyQt6 dependency mis sin g: {e}. Please ensure PyQt6 is cor rectly in stalled")
                            except Exception as e:
                            Logging.Error(f"Add menu barFailed: {e}")
                            #No longer silentlyfail, directly throw Error rais eRuntimeError(f"Menu bar Initialization failed: {e}")from e

    def _Initialize_figure(self):
                            """Initialize chart Setup and layout"""
                            #Setup font style
                            title_fontdict={'fontsize':15,'fontweight':'bold'}
                            axis _fontdict={'fontsize':15}

                            #Create chart and Setup title
                            fig=plt.figure(figsize=(15,6))
                            #Try to Setup window title(add Error process to be compatible with dif ferent backends)
                            try:
                            if hasattr(fig.canvas.manager,'window'):
                            fig.canvas.manager.window.setWin dowTitle(
                            _("Filtered_load_voltage_over_charge","Filtered Load Voltage over Charge"))
                            except Exception as e:
                            Logging.Warning("Cannot Setup chart window title: %s",str(e))

                            #Setup grid layout
                            gs=fig.add_gridspec(1,40)
                            ax=fig.add_subplot(gs[:,5:])                            #Leave left side space for buttons

                            #Setup axis scope and scale
                            ax.axis(self.listAxis)
                            x_ticks=self.listXTicks
                            ax.set_xticks(x_ticks)

                            #SetupY-axis main scale
                            y_major _locator=MultipleLocator(0.2)
                            ax.yaxis.set_major _locator(y_major _locator)

                            #Setup title and labels
                            ax.set_title(_("Filtered",f"Filtered")+" "+self.strPltName,fontdict=title_fontdict)
                            ax.set_xlabel("Charge [mAh]",fontdict=axis _fontdict)
                            ax.set_ylabel(
                            _("Filtered_battery_load_voltage","Filtered Battery Load Voltage")+" [V]",fontdict=axis _fontdict)

                            #Add grid Lin es
                            ax.grid(Lin estyle="--",alpha=0.3)

                            returnfig,ax,title_fontdict,axis _fontdict

    def _plot_battery_Curves(self,ax):
                            """Plot or igin al and Filtered Curves of ownership battery"""
                            Lin es_unFiltered= []
                            Lin es_Filtered= []

                            for bin range(self.intBatteryNum):
                            for cin range(self.in tCurrentLevelNum):
                            try:
    #Plot Origin al Data Curves(default hide)
                            ul,=ax.plot(
                            self.listPlt[c][0][b],
                            self.listPlt[c][1][b],
                            color=self.listColor[c]if c<len(
                            self.listColor)elsef'C{c}',
                            label= [f'{self.listBatteryNameSplit[b]}',
                            _("unFiltered","UnFiltered")],
                            Vis ible=False,
                            lin ewidth=0.5
                            )
                            Lin es_unFiltered.append(ul)

                            #Plot Filtered data Curves(default show)
                            fl,=ax.plot(
                            self.listPlt[c][2][b],
                            self.listPlt[c][3][b],
                            color=self.listColor[c]if c<len(
                            self.listColor)elsef'C{c}',
                            label= [f'{self.listBatteryNameSplit[b]}',_("Filtered","Filtered")],
                            Vis ible=True,
                            lin ewidth=0.5
                            )
                            Lin es_Filtered.append(fl)
                            except Exception as e:
                            Logging.Error("Error occurred When plottin g battery %s, Current Level %s Curves: %s",b,c,e)

                            returnLin es_unFiltered,Lin es_Filtered

    def _create_Modern_button(self,ax,x,y,width,height,text,Callback,
                            is _Toggle=False,Initial_state=False):
                            """
                            Create Modern Button
        
                            Args:
                            ax: matplotlib axis object
                            x, y: button position
                            width, height: button size
                            text: button text
                            Callback: Click Callback function
                            is _Toggle: Whether it is a Toggle button (save status)
                            Initial_state: Initial status
                            """
                            try:
    #Create button background
                            button_bg=FancyBboxPatch(
                            (x,y),width,height,
                            boxstyle=f"round,pad={MODERN_BUTTON_STYLE['paddin g']/100}",
                            facecolor=MODERN_BUTTON_STYLE['in active_color'],
                            edgecolor=MODERN_BUTTON_STYLE['bor der_color'],
                            lin ewidth=MODERN_BUTTON_STYLE['bor der_width'],
                            alpha=0.95,
                            transfor m=ax.transAxes
                            )
                            ax.add_patch(button_bg)

                            #Createbutton text
                            button_text=ax.text(
                            x+width/2,y+height/2,text,
                            ha='center',va='center',
                            fontsize=MODERN_BUTTON_STYLE['font_size'],
                            color=MODERN_BUTTON_STYLE['in active_text_color'],
                            weight=MODERN_BUTTON_STYLE['font_weight']if is _Toggleelse'nor mal',
                            transfor m=ax.transAxes
                            )

                            #Button Status
                            state={'active':Initial_state,'bg':button_bg,'text':button_text,'hover':False}

                            #Initialize button style
                            self._update_button_style(state)

    def on_button_hover(event):
                                    """Mouse hover process"""
                            if event.in axes!=ax:
    #Mouse leaves buttonarea, reset hover status
                            if state['hover']:
                            state['hover']=False
                            self._update_button_style(state)
                            return

                            #Check if mouse is in button scope in side- unif y detection scope
                            is _in _button=(x<=event.xdata<=x+widthand y-0.01<=event.ydata<=y+height+0.01)

                            if is _in _buttonand not state['hover']:
    #Mouse enters button area
                            state['hover']=True
                            self._update_button_style(state,hover=True)
                            ax.figure.canvas.draw_idle()
                            elif not is _in _buttonand state['hover']:
                            #Mouse leaves button area
                            state['hover']=False
                            self._update_button_style(state)
                            ax.figure.canvas.draw_idle()

    def on_button_click(event):
                            if event.in axes!=ax:
                            return

                            #Check if click is in button scope in side- fix click position offset
                            if(x<=event.xdata<=x+widthand y-0.01<=event.ydata<=y+height+0.01):

                            if is _Toggle:
    #Toggle button status
                            state['active']=not state['active']
                            self._update_button_style(state)
                            else:
                            #Sin glebutton, execute back reset style
                            self._update_button_style(state,pressed=True)
                            #DelayReset
                            self._reset_button_after_delay(state,delay=0.1)

                            #ExecuteCallback
                            try:
                            Callback()
                            except Exception as e:
                            Logging.Error("Button Callback execute Error Occurred: %s",e)

                            #Redraw
                            ax.figure.canvas.draw_idle()

                            #ConnectionEvent
                            ax.figure.canvas.mpl_connect('motion_not if y_event',on_button_hover)
                            ax.figure.canvas.mpl_connect('button_press_event',on_button_click)

                            returnstate

                            except Exception as e:
                            Logging.Error("Create Modern ButtonWhenError Occurred: %s",e)
                            returnNone

    def _update_button_style(self,state,pressed=False,hover=False):
                            """Update button style"""
                            try:
                            if pressed:
    #Button Status
                            state['bg'].set_facecolor(MODERN_BUTTON_STYLE['pressed_color'])
                            state['text'].set_color(MODERN_BUTTON_STYLE['active_text_color'])
                            state['text'].set_weight(MODERN_BUTTON_STYLE['font_weight'])
                            elif hover:
                            #Hover status
                            if state['active']:
                            state['bg'].set_facecolor(MODERN_BUTTON_STYLE['hover_color'])
                            state['text'].set_color(MODERN_BUTTON_STYLE['hover_text_color'])
                            else:
                            state['bg'].set_facecolor(MODERN_BUTTON_STYLE['hover_color'])
                            state['text'].set_color(MODERN_BUTTON_STYLE['in active_text_color'])
                            state['text'].set_weight(MODERN_BUTTON_STYLE['font_weight'])
                            elif state['active']:
                            #Active status
                            state['bg'].set_facecolor(MODERN_BUTTON_STYLE['active_color'])
                            state['text'].set_color(MODERN_BUTTON_STYLE['active_text_color'])
                            state['text'].set_weight(MODERN_BUTTON_STYLE['font_weight'])
                            else:
                            #Not YetActive status
                            state['bg'].set_facecolor(MODERN_BUTTON_STYLE['in active_color'])
                            state['text'].set_color(MODERN_BUTTON_STYLE['in active_text_color'])
                            state['text'].set_weight('nor mal')
                            except Exception as e:
                            Logging.Error("Update button styleWhenError Occurred: %s",e)

    def _reset_button_after_delay(self,state,delay=0.1):
                            """DelayResetButton Status"""
                            impor t threading
                            timer=threading.Timer(delay,lambda:self._update_button_style(state))
                            timer.start()

    def _create_Modern_Toggle_group(self,ax,x,y,width,height,buttons_config):
                            """
                            Create Modern Toggle button group
        
                            Args:
                            ax: matplotlib axis object
                            x, y: Button group position
                            width, height: Button group size
                            buttons_config: Button Configure lis t [{'text': 'text', 'Callback': function, 'Initial': status}]
                            """
                            try:
                            button_states= []
                            button_width=width/len(buttons_config)

                            for i,configin enumerate(buttons_config):
                            btn_x=x+i*button_width
                            btn_state=self._create_Modern_button(
                            ax,btn_x,y,button_width-0.005,height,
                            config['text'],config['Callback'],
                            is _Toggle=True,Initial_state=config.get('Initial',False)
                            )
                            if btn_state:
                            button_states.append(btn_state)

                            returnbutton_states

                            except Exception as e:
                            Logging.Error("Create Modern Toggle button groupWhenError Occurred: %s",e)
                            return[]

    def _add_file_operation_buttons(self,fig):
                            """Add file operation button area (open file and exit buttons)"""
                            try:
    #Create file operation button area
                            ax_file=fig.add_axes([0.001,0.90,0.17,0.062])
                            ax_file.set_xlim(0,1)
                            ax_file.set_ylim(0,1)
                            ax_file.axis('off')

                            #Button Configure
                            buttons_config= [
                            {
                            'text':' Open',
                            'Callback':lambda:self._open_file_dialog(),
                            'Initial':False
                            },
                            {
                            'text':' Exit',
                            'Callback':lambda:self._close_viewer(),
                            'Initial':False
                            }
                            ]

                            #Create Modern Button group
                            self.file_button_states = self._create_Modern_Toggle_group(
                            ax_file,0.02,0.15,0.96,0.7,buttons_config
                            )

                            Logging.Info("Successfully added Modern file operation button area")

                            except Exception as e:
                            Logging.Error("Error occurred When creatin g file operation button: %s",e)

    def _close_viewer(self):
                            """Close viewer window"""
                            try:
                            Logging.Info("File operation button: Exit clicked, close vis ualizer window")
                            #Only close current vis ualizerwindow, not exit entire application
                            if self.current_figis not None:
                            plt.close(self.current_fig)
                            self.current_fig = None
                            Logging.Info("Vis ualizer window closed")
                            else:
                            Logging.Warning("Currently no open vis ualizer window")
                            except Exception as e:
                            Logging.Error("Close viewer windowWhenError Occurred: %s",e)

    def _add_Filter_button(self,fig,ax,Lin es_unFiltered,Lin es_Filtered,
                            title_fontdict,axis _fontdict):
                            """Add Filter/unFilter data Toggle button"""
                            try:
    #Create button area- move to left top cor ner, above channel area
                            ax_Filter=fig.add_axes([0.001,0.92,0.12,0.05])
                            ax_Filter.set_xlim(0,1)
                            ax_Filter.set_ylim(0,1)
                            ax_Filter.axis('off')

                            #Button StatusVariable
                            is _Filtered={'value':True}
                            button_state_ref={'button_state':None}

                            #Callback function to Toggle Filter Mode
    def Toggle_Filter_Mode():
                            try:
                            is _Filtered['value']=not is _Filtered['value']

                            #Updatebutton text
                            if button_state_ref['button_state']:
                            new_text=_("button_Filtered"," Filtered")if is _Filtered['value']else_("button_all_data"," All Data")
                            button_state_ref['button_state']['text'].set_text(new_text)

                            if is _Filtered['value']:
    #Switch to Filter Mode
                            fig.canvas.manager.window.setWin dowTitle(
                            _("Filtered_load_voltage_over_charge","Filtered Load Voltage over Charge"))
                            ax.set_title(
                            _("Filtered",f"Filtered")+" "+self.strPltName,fontdict=title_fontdict)
                            ax.set_ylabel(
                            _("Filtered_battery_load_voltage","Filtered Battery Load Voltage")+" [V]",fontdict=axis _fontdict)

                            #Update lin e Vis ibility- main tain consis tent Vis ibility for same battery
                            for iin range(min(len(Lin es_unFiltered),len(Lin es_Filtered))):
    #Get current battery Vis ibility status(based on last Setup)
    #For everybattery, ownership Current Level Vis ibility should main tain consis tent
                            battery_in dex=i%self.intBatteryNum
                            #Check if this battery has Any Vis ible Lin es
                            battery_Vis ible=Any(Lin es_unFiltered[battery_in dex+j*self.intBatteryNum].get_Vis ible()
                            for jin range(self.in tCurrentLevelNum))

                            #Setup this battery ownership Current Level Filter lin e Vis ibility
                            Lin es_Filtered[i].set_Vis ible(battery_Vis ible)
                            Lin es_unFiltered[i].set_Vis ible(False)
                            else:
                            #Switch to unFilter Mode
                            fig.canvas.manager.window.setWin dowTitle(
                            _("unFiltered_load_voltage_over_charge","UnFiltered Load Voltage over Charge"))
                            ax.set_title(
                            _("unFiltered",f"UnFiltered")+" "+self.strPltName,fontdict=title_fontdict)
                            ax.set_ylabel(
                            _("unFiltered_battery_load_voltage","UnFiltered Battery Load Voltage")+" [V]",fontdict=axis _fontdict)

                            #Update lin e Vis ibility- main tain consis tent Vis ibility for same battery
                            for iin range(min(len(Lin es_Filtered),len(Lin es_unFiltered))):
    #Get current battery Vis ibility status(based on last Setup)
                            battery_in dex=i%self.intBatteryNum
                            #Check if this battery has Any Vis ible Lin es
                            battery_Vis ible=Any(Lin es_Filtered[battery_in dex+j*self.intBatteryNum].get_Vis ible()
                            for jin range(self.in tCurrentLevelNum))

                            #Setup this battery ownership Current Level or igin al lin e Vis ibility
                            Lin es_unFiltered[i].set_Vis ible(battery_Vis ible)
                            Lin es_Filtered[i].set_Vis ible(False)

                            fig.canvas.draw_idle()
                            except Exception as e:
                            Logging.Error("Execute Filter Toggle When Error Occurred: %s",e)

                            #Create Modern Filter button
                            button_text=_("button_Filtered"," Filtered")if is _Filtered['value']else_("button_all_data"," All Data")
                            button_state=self._create_Modern_button(
                            ax_Filter,0.02,0.15,0.96,0.7,
                            button_text,Toggle_Filter_Mode,
                            is _Toggle=True,Initial_state=True
                            )

                            #Save button status reference
                            button_state_ref['button_state']=button_state
                            self.Filter_button_state = button_state

                            Logging.Info("Successfully added Modern Filter button")

                            except Exception as e:
                            Logging.Error("Create Filter button When Error Occurred: %s",e)

    def _add_battery_selection_buttons(self,fig,Check_Filter,Lin es_unFiltered,Lin es_Filtered):
                            """Add battery choose Modern Button for Show/Hide Specif ic battery data Curves"""
                            #Initialize default value
                            button_states_lin e1=None
                            button_states_lin e2=None

                            #Create dif ferent button layouts accor din g to battery Number Amount
                            if self.intBatteryNum>32:
                            #Create First button area(First 32 batteries) - width halved
                            button_states_lin e1=self._create_battery_Check_buttons(
                            fig,[0.001,0.005,0.04,0.029*32],0,32,
                            Check_Filter,Lin es_unFiltered,Lin es_Filtered
                            )

                            #Create Button Area(Remain in g Batteries, Maximum 32) - Width Halved, Compact Position
                            button_states_lin e2=self._create_battery_Check_buttons(
                            fig,[0.041,0.005,0.04,0.029*32],32,64,
                            Check_Filter,Lin es_unFiltered,Lin es_Filtered
                            )
                            else:
                            #Create sin gle button area- width halved
                            button_states_lin e1=self._create_battery_Check_buttons(
                            fig,[0.001,0.005,0.04,0.029*32],0,32,
                            Check_Filter,Lin es_unFiltered,Lin es_Filtered
                            )

                            #Create empty Second button area(placeholder) - width halved, compact position
                            ax_empty=fig.add_axes([0.041,0.005,0.04,0.029*32])
                            ax_empty.set_xlim(0,1)
                            ax_empty.set_ylim(0,1)
                            ax_empty.axis('off')

                            #Add placeholder text
                            ax_empty.text(0.5,0.5,'Empty',ha='center',va='center',
                            fontsize=8,alpha=0.5,transfor m=ax_empty.transAxes)

                            button_states_lin e2= []

                            #Stor e ownership button status reference
                            self.battery_button_states = {
                            'lin e1':button_states_lin e1,
                            'lin e2':button_states_lin e2
                            }

                            Logging.Info("Successfully added Modern battery choose button")
                            returnbutton_states_lin e1,button_states_lin e2

    def _create_battery_Check_buttons(self,fig,rect,start_idx,end_idx,
                            Check_Filter,Lin es_unFiltered,Lin es_Filtered):
                            """Create Modern battery choose button"""
                            #Create Modern Button axis ax_buttons=fig.add_axes(rect)
                            ax_buttons.set_xlim(0,1)
                            ax_buttons.set_ylim(0,1)
                            ax_buttons.axis('off')

                            #Ready battery Info and button status- changed to positive sequence
                            battery_Info= []
                            for iin range(start_idx,end_idx):
                            if i<self.intBatteryNum:
                            battery_Info.append({
                            'name':self.listBatteryNameSplit[i],
                            'in dex':i,
                            'Initial_state':True,
                            'is _none':False
                            })
                            else:
                            battery_Info.append({
                            'name':f"Battery {start_idx + 1}",
                            'in dex':i,
                            'Initial_state':False,
                            'is _none':True
                            })

                            #Arrange columns in positive sequence by in dex(ensure positive sequence display)
                            battery_Info.sor t(key=lambda x:x['in dex'])

                            #CalculateButton Layout Parameters- AdaptCompact Layout
                            num_valid_batteries=min(self.intBatteryNum-start_idx,end_idx-start_idx)
                            if num_valid_batteries>0:
                            button_height=0.92/num_valid_batteries
                            button_spacin g=0.04/(num_valid_batteries+1)
                            else:
                            button_height=0.1
                            button_spacin g=0.45

                            #Stor e button status reference
                            button_states= []

                            #BatterytoggleCallbackFunction
    def Toggle_battery_Vis ibility(battery_idx,button_state):
                            try:
                            Logging.debug(f"toggleBattery {battery_idx} vis ibility")

                            #Process Empty Labels
                            if battery_Info[battery_idx-start_idx].get('is _none',False):
                            return

                            #Accor din g to Current Mode(Filter/Unfilter) Update Cor respondin g Lin e Vis ibility
                            is _Filtered=self.Filter_button_state['active']if hasattr(self,'Filter_button_state')elseTrue
                            Logging.debug(f"Current Mode: {'Filter' if is _Filtered else 'Not YetFilter'}")

                            #Fin dCurrentPoin tBatteryIndex
                            battery_in dex=battery_Info[battery_idx-start_idx]['in dex']

                            #Check the Battery Current Status(Based on Current Mode Bottom Lin es)
                            current_Lin es=Lin es_Filteredif is _FilteredelseLin es_unFiltered
                            battery_Vis ible=False
                            for iin range(len(current_Lin es)):
                            if i%self.intBatteryNum==battery_in dex:
                            battery_Vis ible=current_Lin es[i].get_Vis ible()
                            break

                            new_Vis ibility=not battery_Vis ible

                            #Update Current Mode Bottom the Battery Ownership Lin es
                            updated=False
                            for iin range(len(current_Lin es)):
                            if i%self.intBatteryNum==battery_in dex:
                            current_Lin es[i].set_Vis ible(new_Vis ibility)
                            updated=True
                            Logging.debug(f"Lin e {i} vis ibility update: {battery_Vis ible} -> {new_Vis ibility}")

                            #At the sametimeUpdateModeBottomtheBatteryOwnership,Main tain Consis tency
                            other_Lin es=Lin es_unFilteredif is _FilteredelseLin es_Filtered
                            for iin range(len(other_Lin es)):
                            if i%self.intBatteryNum==battery_in dex:
                            other_Lin es[i].set_Vis ible(new_Vis ibility)
                            Logging.debug(f"ModeBottom {i} vis ibilityalso updated to: {new_Vis ibility}")

                            #UpdateButton Status
                            button_state['active']=new_Vis ibility
                            self._update_button_style(button_state)

                            if updated:
                            Logging.debug("Callin g fig.canvas.draw_idle() to refresh chart")
                            fig.canvas.draw_idle()
                            else:
                            Logging.debug("Not haveFin dMatchLin es")
                            except Exception as e:
                            Logging.Error("ExecuteBattery ChooseWhenError Occurred: %s",e)

                            #Create Modern Button
                            for i,batteryin enumerate(battery_Info):
                            if battery['is _none']:
                            continue

                            y_pos=button_spacin g+i*(button_height+button_spacin g)

                            #Create Modern Button- AdaptCompact Layout
                            button_state = self._create_Modern_button(
                            ax_buttons,0.02,y_pos,0.96,button_height,
                            battery['name'][:12] + '...' if len(battery['name']) >12 else battery['name'],
                            lambda idx=battery['in dex']:Toggle_battery_Vis ibility(idx,button_state),
                            is _Toggle=True,
                            Initial_state=battery['Initial_state']
                            )

                            if button_state:
                            button_states.append((battery['in dex'],button_state))

                            Logging.info(f"Successfully created modern battery choose button group ({start_idx}-{end_idx})")
                            returnbutton_states

    def _add_help_text(self,fig):
                            """Add help text to chart right top cor ner"""
                            try:
                            fig.text(0.98,0.85,": will display data poin t to view detailed info",fontsize=7,ha='right')
                            fig.text(0.98,0.78,": , , RightReset",fontsize=7,ha='right')
                            Logging.Info("SuccessfullyAdd Help Text")
                            except Exception as e:
                            Logging.Warning("Add Help TextWhenError Occurred: %s",e)

    def _add_hover_functionality(self,fig,ax,Lin es_Filtered,Lin es_unFiltered,Check_Filter):
                            """addCan,ShowDataPoin tInfo"""
                            try:
    #CreateObject
                            annot=ax.annot ate(
                            '',xy=(0,0),xytext=(10,10),
                            textcoor ds='offset poin ts',
                            bbox=dict(boxstyle='round,pad=0.5',fc='yellow',alpha=0.7),
                            arrowprops=dict(arrowstyle='->')
                            )
                            annot.set_Vis ible(False)

                            # CallbackFunction
    def on_hover(event):
                            if event.in axes==ax:
    #GetCurrentvis ibleLin es
                            current_Lin es=Lin es_Filteredif Check_Filter.get_status()[
                            0]elseLin es_unFiltered

                            #SearchDataPoin t
                            min _dis t=float('in f')
                            closest_poin t=None
                            closest_lin e_label=None

                            for lin ein current_Lin es:
                            if lin e.get_Vis ible():
                            try:
                            x_data=lin e.get_xdata()
                            y_data=lin e.get_ydata()
                            lin e_label=lin e.get_label()

                            #SearchPoin t
                            for i,(x,y)in enumerate(zip(x_data,y_data)):
                            dis t=((x-event.xdata)**2+
                            (y-event.ydata)**2)**0.5
                            # ConsiderDefin itelyScopeInsidePoin t
                            if(dis t<min _dis t
                            and dis t<0.05*(self.maxXaxis-self.listAxis[0])):
                            min _dis t=dis t
                            closest_poin t=(x,y,i)
                            closest_lin e_label=lin e_label
                            except Exception:
                            continue                            #Ignor eProcessWhenError

                            #Updateif closest_poin t:
                            x,y,idx=closest_poin t
                            annot.xy=(x,y)

                            #For matShow
                            label_text=""
                            if is instance(closest_lin e_label,lis t)and len(closest_lin e_label)>0:
                            label_text=f"{closest_lin e_label[0]}"
                            if len(closest_lin e_label)>1:
                            label_text+=f" ({closest_lin e_label[1]})"
                            else:
                            label_text=str(closest_lin e_label)

                            annot.set_text(
                            f"{label_text}\nPoin t {idx}:\nCharge: {x:.2f} mAh\nVoltage: {y:.4f} V")
                            annot.set_Vis ible(True)
                            fig.canvas.draw_idle()
                            else:
                            if annot.get_Vis ible():
                            annot.set_Vis ible(False)
                            fig.canvas.draw_idle()

                            #ConnectionEvent
                            fig.canvas.mpl_connect('motion_not if y_event',on_hover)

                            except Exception as e:
                            Logging.Warning("addCanWhenError Occurred: %s",e)

                            #Notice: _show_error_plot method in front surface def in ition, method updated is enhanced version

                            if __name__=='__main__':
                            """
                            Procedure

                            Create BatteryChartViewer class in stance, automated execute initialization, data read and chart show operation.
    
                            Suppor ted Parameters:
                            - DataDirector yPath parameter
                            """
                            impor t sys
                            from PyQt6.QtWidgetsimpor t QApplication

                            #CreateQtProcedureInstance
                            app=QApplication(sys.argv)

                            data_path=None
                            if len(sys.argv)>1:
                            data_path=sys.argv[1]
                            Logging.Info(f"Data path received: {data_path}")

                            #CreateBatteryChartViewerInstance
                            figure=BatteryChartViewer(data_path=data_path)

                            #if byRowPassDataPath,AutomatedShowChart
                            if data_path:
                            Logging.Info(f"Data path passed, tryin g to show chart")
                            figure.plt_figure()
                            else:
                            Logging.Info(f"Data path not provided, not showin g chart automatically")

                            #StartEventLoop
                            Logging.Info(f"StartQtEventLoop")
                            sys.exit(app.exec())
