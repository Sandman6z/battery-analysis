name: Battery Analysis CI

on:
  push:
    branches: [ main, 'feat/*' ]
  pull_request:
    branches: [ main, 'feat/*' ]

jobs:
  build-and-test:
    runs-on: windows-latest
    permissions:
      contents: write
    env:
      PYTHONIOENCODING: utf-8
      PYTHONUTF8: 1
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install uv
      uses: astral-sh/setup-uv@v3
    
    - name: Create and activate virtual environment
      run: |
        # 创建虚拟环境
        python -m venv .venv
        # 激活虚拟环境（PowerShell命令）
        .\.venv\Scripts\Activate.ps1
        # 验证虚拟环境激活状态
        Write-Host "虚拟环境已激活: $(Get-Command python).Source"
    
    - name: Install dependencies using uv
      run: |
        # 确保激活虚拟环境
        .\.venv\Scripts\Activate.ps1
        uv pip install -e '.[dev,build]'
    
    - name: Lint with flake8
      run: |
        uv add flake8
        # 停止构建如果有Python语法错误或未定义名称
        uv run flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        # 警告但不停止构建其他问题
        uv run flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
    
    - name: 设置Python DLL环境变量
      run: |
        # 获取Python安装路径
        $pythonPath = (Get-Command python).Source
        $pythonDir = Split-Path -Parent $pythonPath
        $pythonHome = Split-Path -Parent $pythonDir
        
        # 检查Python DLL位置并设置环境变量
        Write-Host "Python可执行文件路径: $pythonPath"
        Write-Host "Python目录: $pythonDir"
        Write-Host "Python主目录: $pythonHome"
        
        # 检查常见的DLL路径 - PowerShell数组使用空格分隔元素
        $possibleDllPaths = @(
            (Join-Path $pythonDir 'python311.dll'),
            (Join-Path $pythonHome 'python311.dll'),
            (Join-Path (Join-Path $pythonHome 'DLLs') 'python311.dll'),
            (Join-Path $pythonHome 'libs/python311.dll')
        )
        
        $dllFound = $false
        foreach ($path in $possibleDllPaths) {
            Write-Host "检查DLL路径: $path"
            if (Test-Path $path) {
                Write-Host "找到Python DLL: $path"
                # 设置环境变量，build脚本会使用它
                echo "PYTHON_DLL_PATH=$path" >> $env:GITHUB_ENV
                $dllFound = $true
                break
            }
        }
        
        # 添加错误处理，确保DLL被找到
        if (-not $dllFound) {
            Write-Error "错误：未找到python311.dll文件。尝试的路径："
            foreach ($path in $possibleDllPaths) {
                Write-Error "  - $path"
            }
            exit 1
        }
    
    - name: Run build script
      run: |
        uv run python scripts/build.py Release
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: battery-analysis-build
        path: build/
    
    - name: Generate short SHA
      id: vars
      run: |
        $shortSha = "${{ github.sha }}".Substring(0, 6)
        echo "short_sha=$shortSha" >> $env:GITHUB_OUTPUT
      shell: powershell

    - name: Create GitHub Release
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses: softprops/action-gh-release@v2
      with:
        name: v2.0.0-beta.${{ steps.vars.outputs.short_sha }}
        tag_name: v2.0.0-beta.${{ steps.vars.outputs.short_sha }}
        body: |
          自动构建版本 - Release模式
          构建编号: ${{ github.run_number }}
          提交SHA: ${{ github.sha }}
        draft: false
        prerelease: true
        files: |
          build/Release/*.exe
          build/Release/*.ini
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}