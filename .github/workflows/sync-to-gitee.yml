name: Sync to Gitee

on:
  push:
    branches: [ main ]
  release:
    types: [ published, created, edited, prereleased ]

jobs:
  sync-to-gitee:
    runs-on: windows-latest
    permissions:
      contents: write
      actions: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'actions@github.com'

      - name: Add Gitee remote
        env:
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
        run: |
          git remote add gitee https://${{ secrets.GITEE_USERNAME }}:${env:GITEE_TOKEN}@gitee.com/${{ secrets.GITEE_USERNAME }}/${{ secrets.GITEE_REPO }}.git

      - name: Sync code to Gitee
        run: |
          git push gitee main --force
          git push gitee --tags --force

      - name: Setup GitHub CLI
        uses: actions/setup-node@v4
        with:
          node-version: '16'
      - run: npm install -g @github-cli/cli

      - name: Sync Release to Gitee
        if: github.event_name == 'release'
        env:
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RELEASE_NAME: ${{ github.event.release.name }}
          RELEASE_TAG: ${{ github.event.release.tag_name }}
          RELEASE_BODY: ${{ github.event.release.body }}
          RELEASE_DRAFT: ${{ github.event.release.draft }}
          RELEASE_PRERELEASE: ${{ github.event.release.prerelease }}
        run: |
          # 创建资产目录
          New-Item -ItemType Directory -Force -Path release_assets
          Set-Location release_assets
          
          # 下载GitHub Release资产
          gh release download ${{ env.RELEASE_TAG }} --repo ${{ github.repository }}
          
          # 准备JSON数据
          $releaseBody = ${{ env.RELEASE_BODY }} -replace '"', '\"' -replace "`n", '\\n'
          $jsonData = @"
          {
            "access_token": "${{ secrets.GITEE_TOKEN }}",
            "body": "$releaseBody",
            "draft": ${{ env.RELEASE_DRAFT }},
            "prerelease": ${{ env.RELEASE_PRERELEASE }},
            "tag_name": "${{ env.RELEASE_TAG }}",
            "name": "${{ env.RELEASE_NAME }}"
          }
          "@
          
          # 保存JSON到文件
          $jsonData | Out-File -FilePath release_data.json -Encoding utf8
          
          # 创建Gitee Release
          Write-Host "创建Gitee Release: ${{ env.RELEASE_TAG }}"
          $releaseResponse = Invoke-RestMethod -Uri "https://gitee.com/api/v5/repos/${{ secrets.GITEE_USERNAME }}/${{ secrets.GITEE_REPO }}/releases" -Method Post -ContentType "application/json" -Body $jsonData
          $releaseId = $releaseResponse.id
          
          Write-Host "Gitee Release ID: $releaseId"
          
          # 上传资产文件到Gitee Release
          Get-ChildItem -File | ForEach-Object {
            $fileName = $_.Name
            Write-Host "上传文件: $fileName"
            
            # 使用curl上传文件 (Windows环境中的curl)
            curl.exe -X POST "https://gitee.com/api/v5/repos/${{ secrets.GITEE_USERNAME }}/${{ secrets.GITEE_REPO }}/releases/$releaseId/assets" `
              -H "Authorization: token ${{ secrets.GITEE_TOKEN }}" `
              -F "name=$fileName" `
              -F "attachment=@$fileName"
          }