name: Sync Release to Gitee [å¢å¼ºç‰ˆè°ƒè¯•æ¨¡å¼]

on:
  release:
    types: [published, edited, released]
  push:
    tags:
      - 'v*'  # åŒæ­¥ä»¥ v å¼€å¤´çš„æ ‡ç­¾ï¼Œå¦‚ v1.0.0
    branches:
      - 'main'           # ç›‘å¬ main åˆ†æ”¯çš„æ¨é€
      - 'feat/**'        # ç›‘å¬æ‰€æœ‰ä»¥ feat/ å¼€å¤´çš„åˆ†æ”¯æ¨é€
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘ï¼Œæ–¹ä¾¿è°ƒè¯•
    inputs:
      debug_mode:
        description: 'å¯ç”¨è¯¦ç»†è°ƒè¯•æ¨¡å¼'
        required: true
        default: 'true'
        type: boolean

jobs:
  sync-to-gitee:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # ç¡®ä¿æœ‰å†™å…¥æƒé™
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–æ‰€æœ‰å†å²è®°å½•ï¼ŒåŒ…æ‹¬æ ‡ç­¾
        
    - name: ğŸ” å·¥ä½œæµè§¦å‘ä¿¡æ¯è°ƒè¯•
      run: |
        echo "========================================"
        echo "ğŸ“‹ å·¥ä½œæµè§¦å‘è¯¦ç»†ä¿¡æ¯"
        echo "========================================"
        echo "è§¦å‘äº‹ä»¶: ${{ github.event_name }}"
        echo "è§¦å‘åŠ¨ä½œ: ${{ github.event.action || 'N/A' }}"
        echo "è§¦å‘åˆ†æ”¯/æ ‡ç­¾: ${{ github.ref_name }}"
        echo "å¼•ç”¨ç±»å‹: ${{ github.ref_type || 'N/A' }}"
        echo "ä»“åº“åç§°: ${{ github.repository }}"
        echo "ä»“åº“æ‰€æœ‰è€…: ${{ github.repository_owner }}"
        echo "æ¨é€è€…: ${{ github.actor }}"
        
        if [[ "${{ github.event_name }}" == "release" ]]; then
          echo "\nğŸ“¦ Release äº‹ä»¶è¯¦ç»†ä¿¡æ¯:"
          echo "Release ID: ${{ github.event.release.id || 'N/A' }}"
          echo "Release æ ‡ç­¾: ${{ github.event.release.tag_name || 'N/A' }}"
          echo "Release åç§°: ${{ github.event.release.name || 'N/A' }}"
          echo "Release è‰ç¨¿: ${{ github.event.release.draft }}"
          echo "Release é¢„å‘å¸ƒ: ${{ github.event.release.prerelease }}"
          echo "Release å‘å¸ƒè€…: ${{ github.event.release.author.login || 'N/A' }}"
        fi
        
        echo "\n========================================"
        echo "ğŸ” Git ç¯å¢ƒä¿¡æ¯"
        echo "========================================"
        git --version
        git config --list
        echo "\næœ¬åœ°ä»“åº“ä¿¡æ¯:"
        git remote -v
        git branch -a
        git tag -l | sort -V
        
    - name: Setup Git config
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@users.noreply.github.com"
        
    - name: ğŸ”Œ æ·»åŠ  Gitee è¿œç¨‹ä»“åº“
      run: |
        echo "========================================"
        echo "ğŸ” Gitee Secrets é…ç½®éªŒè¯"
        echo "========================================"
        
        # éªŒè¯å¿…è¦çš„secretsæ˜¯å¦å­˜åœ¨
        if [[ -z "${{ secrets.GITEE_USERNAME }}" ]]; then
          echo "âŒ é”™è¯¯: ç¼ºå°‘Giteeç”¨æˆ·åé…ç½® (GITEE_USERNAME)"
          exit 1
        else
          echo "âœ… Giteeç”¨æˆ·åå·²é…ç½® (é•¿åº¦: ${#GITEE_USERNAME})" | env GITEE_USERNAME="${{ secrets.GITEE_USERNAME }}"
        fi
        
        if [[ -z "${{ secrets.GITEE_TOKEN }}" ]]; then
          echo "âŒ é”™è¯¯: ç¼ºå°‘Giteeè®¿é—®ä»¤ç‰Œé…ç½® (GITEE_TOKEN)"
          exit 1
        else
          echo "âœ… Giteeè®¿é—®ä»¤ç‰Œå·²é…ç½® (é•¿åº¦: ${#GITEE_TOKEN})" | env GITEE_TOKEN="${{ secrets.GITEE_TOKEN }}"
        fi
        
        echo "\n========================================"
        echo "ğŸ”§ é…ç½® Gitee è¿œç¨‹ä»“åº“"
        echo "========================================"
        echo "Repository name: ${{ github.event.repository.name }}"
        
        # æ„å»ºå¹¶æ‰“å°Giteeä»“åº“URLï¼ˆéšè—æ•æ„Ÿä¿¡æ¯ï¼‰
        GITEE_REPO_URL="https://${{ secrets.GITEE_USERNAME }}:***@gitee.com/${{ secrets.GITEE_USERNAME }}/${{ github.event.repository.name }}.git"
        echo "Gitee ä»“åº“ URL (å·²éšè—Token): $GITEE_REPO_URL"
        
        # ç§»é™¤å¯èƒ½å·²å­˜åœ¨çš„giteeè¿œç¨‹ï¼Œé¿å…å†²çª
        git remote remove gitee 2>/dev/null || echo "æ²¡æœ‰æ‰¾åˆ°ç°æœ‰giteeè¿œç¨‹ï¼Œç»§ç»­æ‰§è¡Œ"
        
        # æ·»åŠ æ–°çš„Giteeè¿œç¨‹ä»“åº“
        echo "æ­£åœ¨æ·»åŠ Giteeè¿œç¨‹ä»“åº“..."
        git remote add gitee "https://${{ secrets.GITEE_USERNAME }}:${{ secrets.GITEE_TOKEN }}@gitee.com/${{ secrets.GITEE_USERNAME }}/${{ github.event.repository.name }}.git"
        
        # éªŒè¯è¿œç¨‹ä»“åº“é…ç½®
        echo "\nâœ… è¿œç¨‹ä»“åº“é…ç½®éªŒè¯:"
        git remote -v
        
        # å°è¯•pingè¿œç¨‹ä»“åº“ä»¥éªŒè¯è¿æ¥
        echo "\nğŸ“¡ æµ‹è¯•Giteeä»“åº“è¿æ¥..."
        git ls-remote --heads --tags gitee || echo "âš ï¸  è­¦å‘Š: è¿œç¨‹ä»“åº“è¿æ¥æµ‹è¯•å¤±è´¥ï¼Œä½†ç»§ç»­æ‰§è¡Œåç»­æ­¥éª¤"
        
    - name: ğŸ“¤ æ¨é€åˆ° Gitee
      run: |
        echo "========================================"
        echo "ğŸš€ å‡†å¤‡æ¨é€åˆ° Gitee"
        echo "========================================"
        echo "è§¦å‘äº‹ä»¶: ${{ github.event_name }}"
        echo "è§¦å‘å¼•ç”¨: ${{ github.ref_name }}"
        echo "å¼•ç”¨ç±»å‹: ${{ github.ref_type || 'N/A' }}"
        
        # æ¨é€å½“å‰åˆ†æ”¯ï¼ˆåŸºäºè§¦å‘äº‹ä»¶ï¼‰
        if [[ "${{ github.event_name }}" == "push" ]]; then
          echo "\nğŸ“¤ å¤„ç† Push äº‹ä»¶æ¨é€..."
          # ç¡®å®šè¦æ¨é€çš„å¼•ç”¨
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            # æ¨é€æ ‡ç­¾
            TAG_NAME="${{ github.ref_name }}"
            echo "ğŸ“Œ æ­£åœ¨æ¨é€æ ‡ç­¾ $TAG_NAME åˆ° Gitee..."
            echo "å‘½ä»¤: git push -v gitee refs/tags/$TAG_NAME"
            git push -v gitee "refs/tags/$TAG_NAME"
            PUSH_RESULT=$?
            if [[ $PUSH_RESULT -eq 0 ]]; then
              echo "âœ… æ ‡ç­¾ $TAG_NAME æ¨é€æˆåŠŸ"
            else
              echo "âŒ æ ‡ç­¾ $TAG_NAME æ¨é€å¤±è´¥ï¼Œé”™è¯¯ç : $PUSH_RESULT"
            fi
          else
            # æ¨é€åˆ†æ”¯
            BRANCH_NAME="${{ github.ref_name }}"
            echo "ğŸŒ¿ æ­£åœ¨æ¨é€åˆ†æ”¯ $BRANCH_NAME åˆ° Gitee..."
            echo "å‘½ä»¤: git push -v gitee $BRANCH_NAME"
            git push -v gitee "$BRANCH_NAME"
            PUSH_RESULT=$?
            if [[ $PUSH_RESULT -eq 0 ]]; then
              echo "âœ… åˆ†æ”¯ $BRANCH_NAME æ¨é€æˆåŠŸ"
            else
              echo "âŒ åˆ†æ”¯ $BRANCH_NAME æ¨é€å¤±è´¥ï¼Œé”™è¯¯ç : $PUSH_RESULT"
            fi
          fi
        elif [[ "${{ github.event_name }}" == "release" ]]; then
          echo "\nğŸ“¤ å¤„ç† Release äº‹ä»¶æ¨é€..."
          # æ¨é€æ ‡ç­¾å’Œç›¸å…³åˆ†æ”¯
          RELEASE_TAG="${{ github.event.release.tag_name }}"
          echo "ğŸ“Œ æ­£åœ¨æ¨é€ Release æ ‡ç­¾ $RELEASE_TAG åˆ° Gitee..."
          git push -v gitee "refs/tags/$RELEASE_TAG"
          TAG_PUSH_RESULT=$?
          
          echo "\nğŸŒ¿ æ­£åœ¨æ¨é€ main åˆ†æ”¯åˆ° Gitee..."
          git push -v gitee "main"
          BRANCH_PUSH_RESULT=$?
          
          if [[ $TAG_PUSH_RESULT -eq 0 && $BRANCH_PUSH_RESULT -eq 0 ]]; then
            echo "âœ… Release ç›¸å…³å†…å®¹æ¨é€æˆåŠŸ"
          else
            echo "âŒ Release ç›¸å…³å†…å®¹æ¨é€éƒ¨åˆ†å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
          fi
        else
          echo "ğŸ“¤ å¤„ç†æ‰‹åŠ¨è§¦å‘æˆ–å…¶ä»–äº‹ä»¶æ¨é€..."
          # å¯¹äºæ‰‹åŠ¨è§¦å‘çš„å·¥ä½œæµï¼Œæ¨é€å½“å‰åˆ†æ”¯
          CURRENT_BRANCH=$(git branch --show-current)
          echo "ğŸŒ¿ æ­£åœ¨æ¨é€å½“å‰åˆ†æ”¯ $CURRENT_BRANCH åˆ° Gitee..."
          git push -v gitee "$CURRENT_BRANCH"
        fi
        
        # æ˜¾ç¤ºæ¨é€çŠ¶æ€å’ŒéªŒè¯ä¿¡æ¯
        echo "\n========================================"
        echo "ğŸ“‹ æ¨é€åéªŒè¯ä¿¡æ¯"
        echo "========================================"
        echo "ğŸ“ æœ¬åœ°æ ‡ç­¾åˆ—è¡¨ï¼š"
        git tag -l | sort -V
        
        echo "\nğŸ“¡ Gitee è¿œç¨‹å¼•ç”¨éªŒè¯ï¼š"
        echo "ğŸ” æ£€æŸ¥è¿œç¨‹åˆ†æ”¯ï¼š"
        git ls-remote gitee --heads
        
        echo "\nğŸ” æ£€æŸ¥è¿œç¨‹æ ‡ç­¾ï¼š"
        git ls-remote gitee --tags
        
        # å¦‚æœæ˜¯æ ‡ç­¾æ¨é€ï¼Œç‰¹åˆ«éªŒè¯è¯¥æ ‡ç­¾
        if [[ "${{ github.ref_type }}" == "tag" ]]; then
          echo "\nğŸ” ç‰¹åˆ«éªŒè¯æ ‡ç­¾ ${{ github.ref_name }} æ˜¯å¦å­˜åœ¨äº Giteeï¼š"
          git ls-remote gitee "refs/tags/${{ github.ref_name }}"
          if [[ $? -eq 0 ]]; then
            echo "âœ… æ ‡ç­¾ ${{ github.ref_name }} åœ¨ Gitee ä¸Šå·²å­˜åœ¨"
          else
            echo "âŒ æ ‡ç­¾ ${{ github.ref_name }} åœ¨ Gitee ä¸Šä¸å­˜åœ¨ï¼Œæ¨é€å¯èƒ½å¤±è´¥"
          fi
        fi
        
    - name: ğŸ“‹ æ ‡ç­¾åŒæ­¥çŠ¶æ€æ£€æŸ¥
      run: |
        echo "========================================"
        echo "ğŸ” æ ‡ç­¾åŒæ­¥çŠ¶æ€æ£€æŸ¥"
        echo "========================================"
        
        # è·å–æœ€æ–°çš„æ ‡ç­¾
        echo "ğŸ·ï¸ è·å–æœ¬åœ°æœ€æ–°æ ‡ç­¾..."
        LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "æ— æ ‡ç­¾")
        echo "æœ€æ–°æœ¬åœ°æ ‡ç­¾: $LATEST_TAG"
        
        # åˆ—å‡ºæ‰€æœ‰æœ¬åœ°æ ‡ç­¾
        echo "\nğŸ“‹ æ‰€æœ‰æœ¬åœ°æ ‡ç­¾:"
        git tag -l | sort -V || echo "æœ¬åœ°ä»“åº“ä¸­æš‚æ— æ ‡ç­¾"
        
        # æ£€æŸ¥Giteeä¸Šçš„æ ‡ç­¾
        echo "\nğŸ“¡ Giteeè¿œç¨‹ä»“åº“æ ‡ç­¾:"
        git ls-remote --tags gitee | sort -k2 -V || echo "æ— æ³•è·å–Giteeæ ‡ç­¾ä¿¡æ¯"
        
        echo "\n========================================"
        echo "ğŸ“ åŒæ­¥å®Œæˆä¿¡æ¯"
        echo "========================================"
        echo "æ“ä½œç±»å‹: ${{ github.event_name }}"
        echo "è§¦å‘å¼•ç”¨: ${{ github.ref_name }}"
        echo "è¿è¡ŒæˆåŠŸ: âœ… å·¥ä½œæµæ‰§è¡Œå®Œæˆ"
        echo "\næ³¨æ„: è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—å·²ç”Ÿæˆï¼Œè¯·æ ¹æ®æ—¥å¿—æ’æŸ¥ä»»ä½•å¯èƒ½çš„é—®é¢˜"
        
    - name: ğŸ“¦ åˆ›å»º Gitee Release [å¢å¼ºè°ƒè¯•æ¨¡å¼]
      if: github.event_name == 'release'
      run: |
        echo "========================================"
        echo "ğŸ”§ Gitee Release API æ“ä½œå‡†å¤‡"
        echo "========================================"
        
        # éªŒè¯å¿…è¦çš„secretsæ˜¯å¦å­˜åœ¨
        echo "ğŸ” éªŒè¯Gitee Secrets..."
        if [[ -z "${{ secrets.GITEE_USERNAME }}" ]]; then
          echo "âŒ é”™è¯¯: ç¼ºå°‘Giteeç”¨æˆ·åé…ç½® (GITEE_USERNAME)"
          exit 1
        else
          echo "âœ… Giteeç”¨æˆ·åå·²é…ç½®"
        fi
        
        if [[ -z "${{ secrets.GITEE_TOKEN }}" ]]; then
          echo "âŒ é”™è¯¯: ç¼ºå°‘Giteeè®¿é—®ä»¤ç‰Œé…ç½® (GITEE_TOKEN)"
          exit 1
        else
          echo "âœ… Giteeè®¿é—®ä»¤ç‰Œå·²é…ç½®"
        fi
        
        echo "\n========================================"
        echo "ğŸ“‹ Release ä¿¡æ¯è¯¦æƒ…è°ƒè¯•"
        echo "========================================"
        echo "Repository: ${{ github.event.repository.name }}"
        echo "Release tag: ${{ github.event.release.tag_name }}"
        echo "Release name: ${{ github.event.release.name }}"
        echo "Release body length: ${{ github.event.release.body != '' && (length(github.event.release.body) | int) || 0 }}"
        echo "Release draft: ${{ github.event.release.draft }}"
        echo "Release prerelease: ${{ github.event.release.prerelease }}"
        echo "Release created at: ${{ github.event.release.created_at }}"
        echo "Release published at: ${{ github.event.release.published_at }}"
        echo "Release author: ${{ github.event.release.author.login || 'N/A' }}"
        
        # æå–å‘å¸ƒä¿¡æ¯
        RELEASE_TAG="${{ github.event.release.tag_name }}"
        RELEASE_NAME="${{ github.event.release.name }}"
        # å®‰å…¨å¤„ç†å‘å¸ƒæè¿°
        echo "ğŸ”’ å¤„ç†å‘å¸ƒæè¿°å†…å®¹..."
        RELEASE_BODY=$(echo '${{ github.event.release.body }}' | sed 's/"/\\"/g' || echo "")
        RELEASE_DRAFT="${{ github.event.release.draft }}"
        RELEASE_PRERELEASE="${{ github.event.release.prerelease }}"
        
        echo "âœ… å‘å¸ƒä¿¡æ¯æå–å®Œæˆ"
        
        # å¢å¼ºçš„curlé‡è¯•å‡½æ•°ï¼Œå¸¦è¯¦ç»†è°ƒè¯•
        curl_with_retry() {
          local max_attempts=3
          local attempt=1
          local delay=2
          local method=$1
          local url=$2
          local data=$3
          local operation_name=$4
          
          echo "ğŸ”„ $operation_name - APIè°ƒç”¨ä¿¡æ¯:"
          echo "   æ–¹æ³•: $method"
          echo "   URL: $url"
          echo "   è¯·æ±‚ä½“é•¿åº¦: ${#data} å­—ç¬¦"
          
          while [ $attempt -le $max_attempts ]; do
            echo "ğŸ“ å°è¯•ç¬¬ $attempt/$max_attempts æ¬¡è°ƒç”¨ API..."
            
            # è®°å½•å¼€å§‹æ—¶é—´
            start_time=$(date +%s)
            
            # æ‰§è¡ŒAPIè°ƒç”¨
            response=$(curl -s -w "\n%{http_code}" -X "$method" \
              "$url" \
              -H "Authorization: token ${{ secrets.GITEE_TOKEN }}" \
              -H "Content-Type: application/json" \
              ${data:+-d "$data"})
            
            # è®°å½•ç»“æŸæ—¶é—´
            end_time=$(date +%s)
            duration=$((end_time - start_time))
            
            # è§£æå“åº”
            http_code=$(echo "$response" | tail -n 1)
            response_body=$(echo "$response" | head -n -1)
            
            echo "â±ï¸  APIè°ƒç”¨è€—æ—¶: ${duration}s"
            echo "ğŸ“Š APIå“åº”ä»£ç : $http_code"
            
            # æ£€æŸ¥æ˜¯å¦æˆåŠŸ
            if [ "$http_code" -ge 200 ] && [ "$http_code" -lt 300 ]; then
              echo "âœ… APIè°ƒç”¨æˆåŠŸ: $http_code"
              echo "ğŸ“‹ å“åº”ä½“é•¿åº¦: ${#response_body} å­—ç¬¦"
              
              # å®‰å…¨æ‰“å°å“åº”æ ·æœ¬
              if [ -n "$response_body" ]; then
                echo "ğŸ“„ å“åº”æ ·æœ¬: $(echo "$response_body" | head -c 150)${response_body:150:+...}"
              else
                echo "ğŸ“„ å“åº”ä½“ä¸ºç©º"
              fi
              
              echo "$response_body"
              return 0
            fi
            
            # å¤±è´¥å¤„ç†
            echo "âŒ APIè°ƒç”¨å¤±è´¥: $http_code"
            if [ -n "$response_body" ]; then
              echo "ğŸ“„ é”™è¯¯å“åº”: $(echo "$response_body" | head -c 300)${response_body:300:+...}"
            else
              echo "ğŸ“„ é”™è¯¯å“åº”ä¸ºç©º"
            fi
            
            # å‡†å¤‡é‡è¯•
            attempt=$((attempt + 1))
            
            if [ $attempt -le $max_attempts ]; then
              echo "â³ $delay ç§’åé‡è¯•..."
              sleep $delay
              delay=$((delay * 2))
            fi
          done
          
          echo "âŒ è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•° ($max_attempts)ï¼ŒAPIè°ƒç”¨å¤±è´¥"
          return 1
        }
        
        echo "\n========================================"
        echo "ğŸŒ Gitee API æ“ä½œæµç¨‹"
        echo "========================================"
        
        # æ„å»ºä»“åº“URL
        REPO_URL="https://gitee.com/api/v5/repos/${{ secrets.GITEE_USERNAME }}/${{ github.event.repository.name }}"
        echo "ğŸ“Œ Gitee API ä»“åº“ URL: $REPO_URL"
        
        # 1. éªŒè¯ä»“åº“æ˜¯å¦å­˜åœ¨å’Œè®¿é—®æƒé™
        echo "\nğŸ” æ­¥éª¤1: éªŒè¯ä»“åº“è®¿é—®æƒé™..."
        REPO_INFO=$(curl_with_retry GET "$REPO_URL" "" "éªŒè¯ä»“åº“è®¿é—®")
        if [[ $? -ne 0 ]]; then
          echo "âš ï¸  è­¦å‘Š: æ— æ³•è®¿é—®ä»“åº“æˆ–ä»“åº“ä¸å­˜åœ¨ï¼Œæ£€æŸ¥URLå’Œæƒé™é…ç½®"
          echo "ğŸ” URLæ£€æŸ¥: $REPO_URL"
          echo "ğŸ” ç”¨æˆ·åæ£€æŸ¥: ${{ secrets.GITEE_USERNAME }}"
        else
          echo "âœ… ä»“åº“è®¿é—®æˆåŠŸï¼Œæƒé™éªŒè¯é€šè¿‡"
        fi
        
        # 2. æ„å»ºå®Œæ•´çš„JSONè¯·æ±‚ä½“
        echo "\nğŸ“ æ­¥éª¤2: æ„å»ºRelease JSONè¯·æ±‚ä½“..."
        JSON_PAYLOAD="{\"tag_name\": \"$RELEASE_TAG\", \"name\": \"$RELEASE_NAME\", \"body\": \"$RELEASE_BODY\", \"draft\": $RELEASE_DRAFT, \"prerelease\": $RELEASE_PRERELEASE}"
        echo "âœ… JSONè¯·æ±‚ä½“æ„å»ºå®Œæˆ"
        echo "ğŸ“Š è¯·æ±‚ä½“æ ·æœ¬: $(echo "$JSON_PAYLOAD" | head -c 100)${JSON_PAYLOAD:100:+...}"
        
        # 3. æ£€æŸ¥æ ‡ç­¾æ˜¯å¦å·²å­˜åœ¨äºGitee
        echo "\nğŸ” æ­¥éª¤3: æ£€æŸ¥æ ‡ç­¾ $RELEASE_TAG æ˜¯å¦å­˜åœ¨äºGitee..."
        TAG_ENDPOINT="$REPO_URL/git/refs/tags/$RELEASE_TAG"
        echo "   æ£€æŸ¥URL: $TAG_ENDPOINT"
        TAG_INFO=$(curl_with_retry GET "$TAG_ENDPOINT" "" "æ£€æŸ¥æ ‡ç­¾å­˜åœ¨æ€§")
        if [[ $? -ne 0 ]]; then
          echo "âŒ æ ‡ç­¾åœ¨Giteeä¸Šä¸å­˜åœ¨ï¼Œå°è¯•é‡æ–°æ¨é€æ ‡ç­¾..."
          echo "ğŸš€ æ‰§è¡Œå‘½ä»¤: git push -v gitee refs/tags/$RELEASE_TAG"
          git push -v gitee "refs/tags/$RELEASE_TAG"
          
          # å†æ¬¡éªŒè¯æ ‡ç­¾æ˜¯å¦å­˜åœ¨
          echo "ğŸ” å†æ¬¡éªŒè¯æ ‡ç­¾æ˜¯å¦å­˜åœ¨..."
          git ls-remote gitee "refs/tags/$RELEASE_TAG"
          if [[ $? -eq 0 ]]; then
            echo "âœ… æ ‡ç­¾æ¨é€æˆåŠŸï¼Œåœ¨Giteeä¸Šå·²å­˜åœ¨"
          else
            echo "âŒ æ ‡ç­¾æ¨é€å¤±è´¥ï¼Œå¯èƒ½å­˜åœ¨æƒé™æˆ–ç½‘ç»œé—®é¢˜"
          fi
        else
          echo "âœ… æ ‡ç­¾ $RELEASE_TAG åœ¨Giteeä¸Šå·²å­˜åœ¨"
        fi
        
        # 4. æ£€æŸ¥Releaseæ˜¯å¦å·²å­˜åœ¨
        echo "\nğŸ” æ­¥éª¤4: æ£€æŸ¥Release $RELEASE_TAG æ˜¯å¦å·²å­˜åœ¨..."
        RELEASE_CHECK_ENDPOINT="$REPO_URL/releases/tags/$RELEASE_TAG"
        echo "   æ£€æŸ¥URL: $RELEASE_CHECK_ENDPOINT"
        RESPONSE=$(curl_with_retry GET "$RELEASE_CHECK_ENDPOINT" "" "æ£€æŸ¥Releaseå­˜åœ¨æ€§")
        
        # 5. æ ¹æ®å­˜åœ¨æ€§å†³å®šåˆ›å»ºæˆ–æ›´æ–°
        if echo "$RESPONSE" | grep -q '"id"'; then
          # Releaseå·²å­˜åœ¨ï¼Œæ›´æ–°å®ƒ
          RELEASE_ID=$(echo "$RESPONSE" | grep -o '"id":[0-9]*' | cut -d: -f2 | head -1)
          echo "ğŸ“ å‘ç°å·²å­˜åœ¨çš„Release: $RELEASE_TAG (ID: $RELEASE_ID)"
          echo "ğŸ”„ å‡†å¤‡æ›´æ–°Release..."
          
          UPDATE_ENDPOINT="$REPO_URL/releases/$RELEASE_ID"
          echo "   æ›´æ–°URL: $UPDATE_ENDPOINT"
          UPDATE_RESULT=$(curl_with_retry PATCH "$UPDATE_ENDPOINT" "$JSON_PAYLOAD" "æ›´æ–°Release")
          
          if [[ $? -eq 0 ]]; then
            echo "âœ… æˆåŠŸæ›´æ–°Gitee Release: $RELEASE_TAG"
          else
            echo "âŒ æ›´æ–°Releaseå¤±è´¥ï¼Œæ£€æŸ¥é”™è¯¯æ—¥å¿—"
          fi
        else
          # åˆ›å»ºæ–°Release
          echo "ğŸ“ æœªå‘ç°ç°æœ‰Releaseï¼Œå‡†å¤‡åˆ›å»ºæ–°Release..."
          CREATE_ENDPOINT="$REPO_URL/releases"
          echo "   åˆ›å»ºURL: $CREATE_ENDPOINT"
          CREATE_RESULT=$(curl_with_retry POST "$CREATE_ENDPOINT" "$JSON_PAYLOAD" "åˆ›å»ºRelease")
          
          if [[ $? -eq 0 ]]; then
            echo "âœ… æˆåŠŸåˆ›å»ºGitee Release: $RELEASE_TAG"
          else
            echo "âŒ åˆ›å»ºReleaseå¤±è´¥ï¼Œæ£€æŸ¥é”™è¯¯æ—¥å¿—"
          fi
        fi
        
        # 6. æœ€ç»ˆéªŒè¯
        echo "\n========================================"
        echo "âœ… æœ€ç»ˆéªŒè¯ä¸çŠ¶æ€æ±‡æ€»"
        echo "========================================"
        
        # åˆ—å‡ºGiteeä¸Šçš„å‘å¸ƒ
        echo "\nğŸ“‹ åˆ—å‡ºGiteeä¸Šæœ€æ–°çš„5ä¸ªå‘å¸ƒ:"
        curl_with_retry GET "$REPO_URL/releases?per_page=5" "" "åˆ—å‡ºæœ€æ–°å‘å¸ƒ"
        
        # åˆ—å‡ºGiteeä¸Šçš„æ ‡ç­¾
        echo "\nğŸ·ï¸  åˆ—å‡ºGiteeä¸Šçš„æ ‡ç­¾:"
        curl_with_retry GET "$REPO_URL/git/refs/tags" "" "åˆ—å‡ºæ‰€æœ‰æ ‡ç­¾"
        
        # ç‰¹åˆ«éªŒè¯ç›®æ ‡æ ‡ç­¾å’ŒRelease
        echo "\nğŸ¯ ç‰¹åˆ«éªŒè¯ç›®æ ‡æ ‡ç­¾ $RELEASE_TAG çš„Release:"
        curl_with_retry GET "$RELEASE_CHECK_ENDPOINT" "" "éªŒè¯ç›®æ ‡Release"
        
        echo "\n========================================"
        echo "ğŸ“Š åŒæ­¥æ“ä½œå®ŒæˆçŠ¶æ€æ‘˜è¦"
        echo "========================================"
        echo "ğŸ”„ æ“ä½œç±»å‹: ${{ github.event_name }}"
        echo "ğŸ·ï¸  ç›®æ ‡æ ‡ç­¾: $RELEASE_TAG"
        echo "ğŸ”— ä»“åº“: ${{ github.repository }}"
        echo "ğŸ“ å·¥ä½œæµè¿è¡ŒID: ${{ github.run_id }}"
        echo "========================================"
        echo "è¯·æ£€æŸ¥ä»¥ä¸Šæ—¥å¿—ä»¥ç¡®è®¤åŒæ­¥çŠ¶æ€"