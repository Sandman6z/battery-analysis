name: Sync to Wiki

on:
  push:
    branches: [main, "feat/*"]

jobs:
  sync-wiki:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      PYTHONIOENCODING: utf-8
      PYTHONUTF8: 1
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Wiki initialization Check
        run: |
          # 检查Wiki是否已初始化
          echo "Checking if Wiki is initialized..."
          
          # 直接检查wiki.git仓库是否存在
          WIKI_URL="https://github.com/${{ github.repository }}.wiki.git"
          echo "Checking Wiki repository at: $WIKI_URL"
          
          # 使用git ls-remote检查仓库是否存在
          if git ls-remote --exit-code "$WIKI_URL" > /dev/null 2>&1; then
            echo "✓ Wiki repository exists and is accessible"
          else
            echo "✗ Wiki repository not found or inaccessible"
            echo "Please manually initialize Wiki in GitHub settings:"
            echo "1. Go to GitHub repository > Settings > Features > Wiki"
            echo "2. Enable Wiki feature"
            echo "3. Create at least one Wiki page to initialize the repository"
            exit 0
          fi

      # Sync Markdown to Wiki manually without using hardcoded master branch action
      - name: Sync Markdown to Wiki manually
        run: |
          # Clone the Wiki repository
          git clone https://${{ secrets.GH_PAT }}@github.com/${{ github.repository }}.wiki.git temp_wiki
          
          # Set git configuration
          git config --global user.name "${{ github.event.head_commit.author.name }}"
          git config --global user.email "${{ github.event.head_commit.author.email }}"
          
          # Navigate to Wiki directory
          cd temp_wiki
          
          # Check current branch and create if needed
          CURRENT_BRANCH=$(git symbolic-ref --short HEAD 2>/dev/null || echo "main")
          echo "Current Wiki branch: $CURRENT_BRANCH"
          
          # Create main branch if it doesn't exist
          if [ ! "$CURRENT_BRANCH" = "main" ]; then
            git checkout -b main
            git push -u origin main
          fi
          
          # Clear existing Wiki content (keep .git directory)
          find . -type f -not -name ".git*" -not -path "./.git/*" -delete
          
          # Copy documentation files
          cp -r ../docs/* .
          
          # Convert README.md to Home.md if it exists
          if [ -f "README.md" ]; then
            mv README.md Home.md
          fi
          
          # Add all files
          git add -A
          
          # Check if there are changes to commit
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            # Commit changes
            git commit -m "Update Wiki - ${{ github.event.head_commit.message }}"
            # Push changes
            git push origin main
          fi
          
          # Navigate back and clean up
          cd ..
          rm -rf temp_wiki
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}