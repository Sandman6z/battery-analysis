name: Sync to Gitee

on:
  release:
    types: [published, released]
  push:
    tags:
      - 'v*'  # 同步以 v 开头的标签
    branches:
      - 'main'  # 同步 main 分支
  workflow_dispatch:  # 允许手动触发

jobs:
  sync-to-gitee:
    runs-on: windows-latest
    permissions:
      contents: write  # 确保有写入权限

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # 获取所有历史记录，包括标签

    - name: Setup Git config
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "zbnsandman@google.com"
      shell: powershell

    - name: Check if Gitee secrets are configured
      id: check_secrets
      run: |
        if (-not (Test-Path env:GITEE_USERNAME) -or [string]::IsNullOrEmpty($env:GITEE_USERNAME)) {
          Write-Output "secrets_configured=false"
          Write-Warning "GITEE_USERNAME secret is not configured"
        } elseif (-not (Test-Path env:GITEE_TOKEN) -or [string]::IsNullOrEmpty($env:GITEE_TOKEN)) {
          Write-Output "secrets_configured=false"
          Write-Warning "GITEE_TOKEN secret is not configured"
        } else {
          Write-Output "secrets_configured=true"
          Write-Output "Gitee secrets are configured"
        }
      shell: powershell

    - name: Add Gitee remote repository
      if: steps.check_secrets.outputs.secrets_configured == 'true'
      run: |
        # 获取仓库名称
        $repoName = $env:GITHUB_REPOSITORY.Split('/')[1]
        
        # 移除现有的 gitee 远程仓库（如果存在）
        git remote remove gitee 2>&1 | Out-Null
        
        # 添加新的 Gitee 远程仓库
        $giteeRepoUrl = "https://${env:GITEE_USERNAME}:${env:GITEE_TOKEN}@gitee.com/${env:GITEE_USERNAME}/${repoName}.git"
        git remote add gitee $giteeRepoUrl
        
        # 验证远程仓库配置
        git remote -v
      shell: powershell

    - name: Push to Gitee
      if: steps.check_secrets.outputs.secrets_configured == 'true'
      run: |
        Write-Output "正在同步到 Gitee..."
        Write-Output "触发事件: $env:GITHUB_EVENT_NAME"
        Write-Output "引用: $env:GITHUB_REF"
        
        # 根据触发事件确定要推送的内容
        if ($env:GITHUB_EVENT_NAME -eq 'push') {
          if ($env:GITHUB_REF_TYPE -eq 'tag') {
            # 推送标签
            $tagName = $env:GITHUB_REF_NAME
            Write-Output "推送标签 $tagName 到 Gitee..."
            git push -v gitee "refs/tags/$tagName"
          } else {
            # 推送分支
            $branchName = $env:GITHUB_REF_NAME
            Write-Output "推送分支 $branchName 到 Gitee..."
            git push -v gitee "$branchName"
          }
        } elseif ($env:GITHUB_EVENT_NAME -eq 'release') {
          # 推送标签和 main 分支
          $releaseTag = $env:GITHUB_REF_NAME
          Write-Output "推送 Release 标签 $releaseTag 到 Gitee..."
          git push -v gitee "refs/tags/$releaseTag"
          
          Write-Output "推送 main 分支到 Gitee..."
          git push -v gitee "main"
        } else {
          # 手动触发，推送当前分支
          $currentBranch = git branch --show-current
          Write-Output "推送当前分支 $currentBranch 到 Gitee..."
          git push -v gitee "$currentBranch"
        }
      shell: powershell